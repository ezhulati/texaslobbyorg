---
import { getLobbyistSlug } from '@/lib/auth-helpers';
import { supabase } from '@/lib/supabase';

const pathname = Astro.url.pathname;

const navLinks = [
  { href: '/lobbyists', label: 'Find Lobbyists' },
  { href: '/cities', label: 'By City' },
  { href: '/subjects', label: 'By Expertise' },
  { href: '/how-it-works', label: 'How It Works' },
];

// Get current user from middleware (stored in Astro.locals)
const currentUser = Astro.locals.user;
const isAuthenticated = Astro.locals.isAuthenticated;
const isLobbyist = currentUser?.role === 'lobbyist';
const isSearcher = currentUser?.role === 'searcher';
const isAdmin = currentUser?.role === 'admin';

// Get lobbyist profile slug if applicable
const lobbyistSlug = isLobbyist && currentUser ? await getLobbyistSlug(currentUser.id) : null;

// Get pending count for admin
let pendingCount = 0;
if (isAdmin) {
  const { count } = await supabase
    .from('lobbyists')
    .select('*', { count: 'exact', head: true })
    .eq('is_pending', true);
  pendingCount = count || 0;
}
---

<header class="border-b border-border bg-background sticky top-0 z-50">
  <div class="container">
    <div class="flex h-16 items-center justify-between">
      <!-- Logo -->
      <a href="/" class="flex items-center">
        <img
          src="/images/Texas%20Lobby%20Logo%20Transparent%20bg.svg"
          alt="TexasLobby.org"
          class="h-14 w-auto"
        />
      </a>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center space-x-6">
        {navLinks.map((link) => (
          <a
            href={link.href}
            class:list={[
              'text-sm font-medium transition-colors hover:text-texas-blue-500',
              pathname === link.href ? 'text-texas-blue-500' : 'text-muted-foreground',
            ]}
          >
            {link.label}
          </a>
        ))}
      </nav>

      <!-- Desktop CTA Buttons -->
      <div class="hidden md:flex items-center space-x-4">
        {!isAuthenticated && (
          <a
            href="/login"
            class="text-sm font-medium text-muted-foreground hover:text-foreground"
          >
            Log In
          </a>
        )}

        {isSearcher && (
          <>
            <a
              href="/favorites"
              class="text-sm font-medium text-muted-foreground hover:text-foreground"
            >
              My Favorites
            </a>
            <div class="relative group">
              <button
                class="flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground"
                aria-label="User menu"
              >
                <div class="h-8 w-8 rounded-full bg-texas-blue-100 flex items-center justify-center text-texas-blue-600 font-semibold text-xs">
                  {((currentUser.first_name?.[0] || '') + (currentUser.last_name?.[0] || '')).toUpperCase() || currentUser.email[0].toUpperCase()}
                </div>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div class="absolute right-0 mt-2 w-48 bg-white border border-border rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all">
                <a href="/favorites" class="block px-4 py-2 text-sm text-foreground hover:bg-accent">View Favorites</a>
                <a href="/account" class="block px-4 py-2 text-sm text-foreground hover:bg-accent">Account Settings</a>
                <hr class="my-1 border-border" />
                <a href="/api/auth/signout" class="block px-4 py-2 text-sm text-red-600 hover:bg-accent">Log Out</a>
              </div>
            </div>
          </>
        )}

        {isLobbyist && (
          <>
            <a
              href="/dashboard"
              class="text-sm font-medium text-muted-foreground hover:text-foreground"
            >
              Dashboard
            </a>
            <div class="relative group">
              <button
                class="flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground"
                aria-label="User menu"
              >
                <div class="h-8 w-8 rounded-full bg-texas-blue-100 flex items-center justify-center text-texas-blue-600 font-semibold text-xs">
                  {((currentUser.first_name?.[0] || '') + (currentUser.last_name?.[0] || '')).toUpperCase() || currentUser.email[0].toUpperCase()}
                </div>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div class="absolute right-0 mt-2 w-48 bg-white border border-border rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all">
                {lobbyistSlug && <a href={`/lobbyists/${lobbyistSlug}`} class="block px-4 py-2 text-sm text-foreground hover:bg-accent">My Profile</a>}
                <a href="/dashboard" class="block px-4 py-2 text-sm text-foreground hover:bg-accent">Edit Profile</a>
                <a href="/dashboard/analytics" class="block px-4 py-2 text-sm text-foreground hover:bg-accent">Analytics</a>
                <a href="/dashboard/subscription" class="block px-4 py-2 text-sm text-foreground hover:bg-accent">Plan & Billing</a>
                <a href="/account" class="block px-4 py-2 text-sm text-foreground hover:bg-accent">Account Settings</a>
                <hr class="my-1 border-border" />
                <a href="/api/auth/signout" class="block px-4 py-2 text-sm text-red-600 hover:bg-accent">Log Out</a>
              </div>
            </div>
          </>
        )}

        {isAdmin && (
          <>
            <a
              href="/admin"
              class="text-sm font-medium text-muted-foreground hover:text-foreground flex items-center gap-2"
            >
              Admin
              {pendingCount > 0 && (
                <span class="inline-flex items-center justify-center h-5 w-5 rounded-full bg-amber-500 text-xs font-semibold text-white">
                  {pendingCount}
                </span>
              )}
            </a>
            <div class="relative group">
              <button
                class="flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground"
                aria-label="User menu"
              >
                <div class="h-8 w-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-semibold text-xs">
                  {((currentUser.first_name?.[0] || '') + (currentUser.last_name?.[0] || '')).toUpperCase() || currentUser.email[0].toUpperCase()}
                </div>
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div class="absolute right-0 mt-2 w-48 bg-white border border-border rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all">
                <a href="/admin" class="block px-4 py-2 text-sm text-foreground hover:bg-accent">Dashboard</a>
                <a href="/admin/pending-profiles" class="block px-4 py-2 text-sm text-foreground hover:bg-accent flex items-center justify-between">
                  Pending Approvals
                  {pendingCount > 0 && (
                    <span class="inline-flex items-center justify-center h-5 w-5 rounded-full bg-amber-500 text-xs font-semibold text-white">
                      {pendingCount}
                    </span>
                  )}
                </a>
                <a href="/admin/lobbyists" class="block px-4 py-2 text-sm text-foreground hover:bg-accent">Manage Lobbyists</a>
                <a href="/admin/users" class="block px-4 py-2 text-sm text-foreground hover:bg-accent">Manage Users</a>
                <hr class="my-1 border-border" />
                <a href="/account" class="block px-4 py-2 text-sm text-foreground hover:bg-accent">Account Settings</a>
                <hr class="my-1 border-border" />
                <a href="/api/auth/signout" class="block px-4 py-2 text-sm text-red-600 hover:bg-accent">Log Out</a>
              </div>
            </div>
          </>
        )}
      </div>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-button"
        class="md:hidden inline-flex items-center justify-center rounded-md p-2 text-muted-foreground hover:bg-accent hover:text-foreground"
        aria-label="Open menu"
        aria-expanded="false"
      >
        <svg
          id="menu-icon"
          class="h-6 w-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16M4 18h16"
          ></path>
        </svg>
        <svg
          id="close-icon"
          class="h-6 w-6 hidden"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Menu Overlay -->
  <div
    id="mobile-menu-overlay"
    class="fixed inset-0 bg-black/50 z-40 md:hidden hidden"
    aria-hidden="true"
  ></div>

  <!-- Mobile Menu Drawer -->
  <div
    id="mobile-menu"
    class="fixed top-0 right-0 bottom-0 w-[280px] bg-background border-l border-border z-50 md:hidden transform translate-x-full transition-transform duration-300 ease-in-out"
    role="dialog"
    aria-modal="true"
    aria-label="Mobile menu"
  >
    <div class="flex flex-col h-full">
      <!-- Mobile Menu Header -->
      <div class="flex items-center justify-between p-4 border-b border-border">
        <span class="text-lg font-bold text-foreground">Menu</span>
        <button
          id="mobile-menu-close"
          class="inline-flex items-center justify-center rounded-md p-2 text-muted-foreground hover:bg-accent hover:text-foreground"
          aria-label="Close menu"
        >
          <svg
            class="h-6 w-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Mobile Navigation Links -->
      <nav class="flex-1 overflow-y-auto py-4">
        {navLinks.map((link) => (
          <a
            href={link.href}
            class:list={[
              'block px-4 py-3 text-base font-medium transition-colors hover:bg-accent',
              pathname === link.href ? 'text-texas-blue-500 bg-accent/50' : 'text-foreground',
            ]}
          >
            {link.label}
          </a>
        ))}
      </nav>

      <!-- Mobile CTA Buttons -->
      <div class="border-t border-border p-4 space-y-3">
        {!isAuthenticated && (
          <a
            href="/login"
            class="block w-full text-center px-4 py-2.5 text-sm font-medium text-foreground border border-border rounded-md hover:bg-accent transition-colors"
          >
            Log In
          </a>
        )}

        {isSearcher && (
          <>
            <a
              href="/favorites"
              class="block w-full text-center px-4 py-2.5 text-sm font-medium text-white bg-texas-blue-500 rounded-md hover:bg-texas-blue-600 transition-colors"
            >
              My Favorites
            </a>
            <a
              href="/account"
              class="block w-full text-center px-4 py-2.5 text-sm font-medium text-foreground border border-border rounded-md hover:bg-accent transition-colors"
            >
              Account Settings
            </a>
            <a
              href="/api/auth/signout"
              class="block w-full text-center px-4 py-2.5 text-sm font-medium text-red-600 border border-red-200 rounded-md hover:bg-red-50 transition-colors"
            >
              Log Out
            </a>
          </>
        )}

        {isLobbyist && (
          <>
            <a
              href="/dashboard"
              class="block w-full text-center px-4 py-2.5 text-sm font-medium text-white bg-texas-blue-500 rounded-md hover:bg-texas-blue-600 transition-colors"
            >
              Dashboard
            </a>
            {lobbyistSlug && (
              <a
                href={`/lobbyists/${lobbyistSlug}`}
                class="block w-full text-center px-4 py-2.5 text-sm font-medium text-foreground border border-border rounded-md hover:bg-accent transition-colors"
              >
                My Profile
              </a>
            )}
            <a
              href="/dashboard"
              class="block w-full text-center px-4 py-2.5 text-sm font-medium text-foreground border border-border rounded-md hover:bg-accent transition-colors"
            >
              Edit Profile
            </a>
            <a
              href="/dashboard/subscription"
              class="block w-full text-center px-4 py-2.5 text-sm font-medium text-foreground border border-border rounded-md hover:bg-accent transition-colors"
            >
              Plan & Billing
            </a>
            <a
              href="/account"
              class="block w-full text-center px-4 py-2.5 text-sm font-medium text-foreground border border-border rounded-md hover:bg-accent transition-colors"
            >
              Account Settings
            </a>
            <a
              href="/api/auth/signout"
              class="block w-full text-center px-4 py-2.5 text-sm font-medium text-red-600 border border-red-200 rounded-md hover:bg-red-50 transition-colors"
            >
              Log Out
            </a>
          </>
        )}
      </div>
    </div>
  </div>
</header>

<script>
  // Mobile menu toggle functionality
  const menuButton = document.getElementById('mobile-menu-button');
  const menuCloseButton = document.getElementById('mobile-menu-close');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
  const menuIcon = document.getElementById('menu-icon');
  const closeIcon = document.getElementById('close-icon');

  function openMenu() {
    mobileMenu?.classList.remove('translate-x-full');
    mobileMenuOverlay?.classList.remove('hidden');
    menuButton?.setAttribute('aria-expanded', 'true');
    menuIcon?.classList.add('hidden');
    closeIcon?.classList.remove('hidden');
    // Prevent body scroll when menu is open
    document.body.style.overflow = 'hidden';
  }

  function closeMenu() {
    mobileMenu?.classList.add('translate-x-full');
    mobileMenuOverlay?.classList.add('hidden');
    menuButton?.setAttribute('aria-expanded', 'false');
    menuIcon?.classList.remove('hidden');
    closeIcon?.classList.add('hidden');
    // Restore body scroll
    document.body.style.overflow = '';
  }

  // Open menu
  menuButton?.addEventListener('click', openMenu);

  // Close menu
  menuCloseButton?.addEventListener('click', closeMenu);
  mobileMenuOverlay?.addEventListener('click', closeMenu);

  // Close on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !mobileMenu?.classList.contains('translate-x-full')) {
      closeMenu();
    }
  });
</script>
