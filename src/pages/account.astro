---
import Layout from '@/components/astro/Layout.astro';

// Get current user from middleware
const currentUser = Astro.locals.user;
const isAuthenticated = Astro.locals.isAuthenticated;

// Redirect to login if not authenticated
if (!isAuthenticated || !currentUser) {
  return Astro.redirect('/login');
}
---

<Layout
  title="Account Settings | TexasLobby.org"
  description="Manage your account settings and preferences"
>
  <div class="container max-w-4xl py-8 md:py-12">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-foreground mb-2">Account Settings</h1>
      <p class="text-muted-foreground">
        Manage your account information and security settings
      </p>
    </div>

    <!-- Success/Error Messages -->
    <div id="message-container" class="mb-6 hidden">
      <div id="success-message" class="hidden p-4 rounded-md bg-green-50 border border-green-200 text-green-800">
        <p id="success-text"></p>
      </div>
      <div id="error-message" class="hidden p-4 rounded-md bg-red-50 border border-red-200 text-red-800">
        <p id="error-text"></p>
      </div>
    </div>

    <div class="space-y-6">
      <!-- Profile Information Card -->
      <div class="bg-card border border-border rounded-lg p-6">
        <h2 class="text-xl font-semibold text-foreground mb-4">Profile Information</h2>

        <form id="profile-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="first_name" class="block text-sm font-medium text-foreground mb-2">
                First Name
              </label>
              <input
                type="text"
                id="first_name"
                name="first_name"
                value={currentUser.first_name || ''}
                class="w-full px-3 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-texas-blue-500"
                placeholder="First name"
              />
            </div>

            <div>
              <label for="last_name" class="block text-sm font-medium text-foreground mb-2">
                Last Name
              </label>
              <input
                type="text"
                id="last_name"
                name="last_name"
                value={currentUser.last_name || ''}
                class="w-full px-3 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-texas-blue-500"
                placeholder="Last name"
              />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">
              Email Address
            </label>
            <p class="text-foreground">{currentUser.email}</p>
            <p class="text-xs text-muted-foreground mt-1">
              Contact support to change your email address
            </p>
          </div>

          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">
              Account Type
            </label>
            <p class="text-foreground capitalize">{currentUser.role}</p>
          </div>

          <button
            type="submit"
            class="inline-flex items-center justify-center rounded-md bg-texas-blue-500 px-4 py-2 text-sm font-medium text-white hover:bg-texas-blue-600 focus:outline-none focus:ring-2 focus:ring-texas-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span class="button-text">Save Changes</span>
            <span class="loading-spinner hidden ml-2">
              <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
        </form>
      </div>

      <!-- Change Password Card -->
      <div class="bg-card border border-border rounded-lg p-6">
        <h2 class="text-xl font-semibold text-foreground mb-4">Change Password</h2>

        <form id="password-form" class="space-y-4">
          <div>
            <label for="current_password" class="block text-sm font-medium text-foreground mb-2">
              Current Password
            </label>
            <input
              type="password"
              id="current_password"
              name="current_password"
              class="w-full px-3 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-texas-blue-500"
              placeholder="Enter current password"
              required
            />
          </div>

          <div>
            <label for="new_password" class="block text-sm font-medium text-foreground mb-2">
              New Password
            </label>
            <input
              type="password"
              id="new_password"
              name="new_password"
              class="w-full px-3 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-texas-blue-500"
              placeholder="Enter new password (min 8 characters)"
              minlength="8"
              required
            />
            <p class="text-xs text-muted-foreground mt-1">
              Password must be at least 8 characters long
            </p>
          </div>

          <div>
            <label for="confirm_password" class="block text-sm font-medium text-foreground mb-2">
              Confirm New Password
            </label>
            <input
              type="password"
              id="confirm_password"
              name="confirm_password"
              class="w-full px-3 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-texas-blue-500"
              placeholder="Confirm new password"
              minlength="8"
              required
            />
          </div>

          <button
            type="submit"
            class="inline-flex items-center justify-center rounded-md bg-texas-blue-500 px-4 py-2 text-sm font-medium text-white hover:bg-texas-blue-600 focus:outline-none focus:ring-2 focus:ring-texas-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span class="button-text">Update Password</span>
            <span class="loading-spinner hidden ml-2">
              <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
        </form>
      </div>

      <!-- Data Export & Privacy -->
      <div class="bg-card border border-border rounded-lg p-6">
        <h2 class="text-xl font-semibold text-foreground mb-2">Data & Privacy</h2>
        <p class="text-sm text-muted-foreground mb-4">
          Download a complete copy of your data or manage your account deletion.
        </p>

        <a
          href="/api/account/export-data"
          class="inline-flex items-center justify-center rounded-md border border-border bg-background px-4 py-2 text-sm font-medium text-foreground hover:bg-accent focus:outline-none focus:ring-2 focus:ring-texas-blue-500"
        >
          <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
          Export My Data (JSON)
        </a>
      </div>

      <!-- Danger Zone -->
      <div class="bg-card border border-red-200 rounded-lg p-6">
        <h2 class="text-xl font-semibold text-red-600 mb-2">Delete Account</h2>
        <p class="text-sm text-muted-foreground mb-4">
          Deleting your account will schedule it for permanent deletion in 30 days. You can recover your account during this grace period by logging back in.
        </p>

        <div class="space-y-2 mb-4">
          <h3 class="text-sm font-medium text-foreground">What will be deleted:</h3>
          <ul class="text-sm text-muted-foreground space-y-1 ml-4">
            <li>• Your profile and account information</li>
            <li>• Your saved favorites</li>
            <li>• Your browsing history</li>
            {currentUser.role === 'lobbyist' && <li>• Your lobbyist profile and listing</li>}
          </ul>
        </div>

        <button
          type="button"
          id="delete-account-btn"
          class="inline-flex items-center justify-center rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500"
        >
          Delete Account
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Account Confirmation Modal -->
  <div id="delete-modal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
      <h3 class="text-xl font-semibold text-foreground mb-4">Delete Account</h3>

      <div class="mb-6 space-y-4">
        <p class="text-muted-foreground">
          Your account will be scheduled for deletion with a <strong>30-day grace period</strong>. During this time:
        </p>
        <ul class="text-sm text-muted-foreground space-y-2 ml-4">
          <li>• You can recover your account by logging back in</li>
          <li>• Your data remains accessible for recovery</li>
          <li>• After 30 days, your account will be permanently deleted</li>
        </ul>

        <div class="border-t border-border pt-4">
          <label for="delete-password" class="block text-sm font-medium text-foreground mb-2">
            Confirm your password to continue
          </label>
          <input
            type="password"
            id="delete-password"
            class="w-full px-3 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-red-500"
            placeholder="Enter your password"
            required
          />
        </div>

        <div>
          <label for="delete-reason" class="block text-sm font-medium text-foreground mb-2">
            Reason for leaving (optional)
          </label>
          <textarea
            id="delete-reason"
            rows="2"
            class="w-full px-3 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-red-500"
            placeholder="Help us improve by sharing why you're leaving..."
          ></textarea>
        </div>
      </div>

      <div class="flex gap-3 justify-end">
        <button
          id="cancel-delete-btn"
          class="px-4 py-2 text-sm font-medium text-foreground border border-border rounded-md hover:bg-accent"
        >
          Cancel
        </button>
        <button
          id="confirm-delete-btn"
          class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 disabled:opacity-50"
        >
          Schedule Deletion
        </button>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Helper functions
  function showMessage(type: 'success' | 'error', message: string) {
    const container = document.getElementById('message-container');
    const successDiv = document.getElementById('success-message');
    const errorDiv = document.getElementById('error-message');
    const successText = document.getElementById('success-text');
    const errorText = document.getElementById('error-text');

    if (!container || !successDiv || !errorDiv || !successText || !errorText) return;

    // Hide both messages first
    successDiv.classList.add('hidden');
    errorDiv.classList.add('hidden');
    container.classList.remove('hidden');

    if (type === 'success') {
      successText.textContent = message;
      successDiv.classList.remove('hidden');
    } else {
      errorText.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    // Scroll to top to show message
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Auto-hide after 5 seconds
    setTimeout(() => {
      container.classList.add('hidden');
    }, 5000);
  }

  function setButtonLoading(button: HTMLButtonElement, loading: boolean) {
    const text = button.querySelector('.button-text');
    const spinner = button.querySelector('.loading-spinner');

    if (loading) {
      button.disabled = true;
      spinner?.classList.remove('hidden');
    } else {
      button.disabled = false;
      spinner?.classList.add('hidden');
    }
  }

  // Profile Form Handler
  const profileForm = document.getElementById('profile-form') as HTMLFormElement;
  profileForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = profileForm.querySelector('button[type="submit"]') as HTMLButtonElement;
    setButtonLoading(submitBtn, true);

    const formData = new FormData(profileForm);
    const first_name = formData.get('first_name') as string;
    const last_name = formData.get('last_name') as string;

    try {
      const response = await fetch('/api/account/update-profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ first_name, last_name }),
      });

      const data = await response.json();

      if (response.ok) {
        showMessage('success', 'Profile updated successfully!');
      } else {
        showMessage('error', data.error || 'Failed to update profile');
      }
    } catch (error) {
      showMessage('error', 'An error occurred. Please try again.');
    } finally {
      setButtonLoading(submitBtn, false);
    }
  });

  // Password Form Handler
  const passwordForm = document.getElementById('password-form') as HTMLFormElement;
  passwordForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = passwordForm.querySelector('button[type="submit"]') as HTMLButtonElement;
    setButtonLoading(submitBtn, true);

    const formData = new FormData(passwordForm);
    const current_password = formData.get('current_password') as string;
    const new_password = formData.get('new_password') as string;
    const confirm_password = formData.get('confirm_password') as string;

    // Validate passwords match
    if (new_password !== confirm_password) {
      showMessage('error', 'New passwords do not match');
      setButtonLoading(submitBtn, false);
      return;
    }

    // Validate password length
    if (new_password.length < 8) {
      showMessage('error', 'Password must be at least 8 characters long');
      setButtonLoading(submitBtn, false);
      return;
    }

    try {
      const response = await fetch('/api/account/update-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ current_password, new_password }),
      });

      const data = await response.json();

      if (response.ok) {
        showMessage('success', 'Password updated successfully!');
        passwordForm.reset();
      } else {
        showMessage('error', data.error || 'Failed to update password');
      }
    } catch (error) {
      showMessage('error', 'An error occurred. Please try again.');
    } finally {
      setButtonLoading(submitBtn, false);
    }
  });

  // Delete Account Modal Handlers
  const deleteBtn = document.getElementById('delete-account-btn');
  const deleteModal = document.getElementById('delete-modal');
  const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
  const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

  deleteBtn?.addEventListener('click', () => {
    deleteModal?.classList.remove('hidden');
  });

  cancelDeleteBtn?.addEventListener('click', () => {
    deleteModal?.classList.add('hidden');
  });

  confirmDeleteBtn?.addEventListener('click', async () => {
    const passwordInput = document.getElementById('delete-password') as HTMLInputElement;
    const reasonInput = document.getElementById('delete-reason') as HTMLTextAreaElement;

    const password = passwordInput?.value;
    const reason = reasonInput?.value;

    if (!password) {
      showMessage('error', 'Password is required to delete your account');
      return;
    }

    // Disable button during request
    if (confirmDeleteBtn) {
      confirmDeleteBtn.disabled = true;
      confirmDeleteBtn.textContent = 'Processing...';
    }

    try {
      const response = await fetch('/api/account/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          password,
          reason: reason || null,
          immediate: false, // Use grace period (30 days)
        }),
      });

      const data = await response.json();

      if (response.ok) {
        // Show success message with scheduled date
        const scheduledDate = data.scheduled_date
          ? new Date(data.scheduled_date).toLocaleDateString()
          : 'in 30 days';

        // Redirect to homepage with deletion confirmation
        window.location.href = `/?message=account-deletion-scheduled&date=${encodeURIComponent(scheduledDate)}`;
      } else {
        showMessage('error', data.error || 'Failed to delete account');
        deleteModal?.classList.add('hidden');

        // Reset button
        if (confirmDeleteBtn) {
          confirmDeleteBtn.disabled = false;
          confirmDeleteBtn.textContent = 'Schedule Deletion';
        }
      }
    } catch (error) {
      showMessage('error', 'An error occurred. Please try again.');
      deleteModal?.classList.add('hidden');

      // Reset button
      if (confirmDeleteBtn) {
        confirmDeleteBtn.disabled = false;
        confirmDeleteBtn.textContent = 'Schedule Deletion';
      }
    }
  });

  // Close modal on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !deleteModal?.classList.contains('hidden')) {
      deleteModal?.classList.add('hidden');
    }
  });
</script>
