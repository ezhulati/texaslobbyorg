---
import Layout from '@/components/astro/Layout.astro';

// Get current user from middleware
const currentUser = Astro.locals.user;
const isAuthenticated = Astro.locals.isAuthenticated;

// Redirect to login if not authenticated
if (!isAuthenticated || !currentUser) {
  return Astro.redirect('/login');
}
---

<Layout
  title="Account Settings | TexasLobby.org"
  description="Manage your account settings and preferences"
>
  <div class="container max-w-4xl py-8 md:py-12">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-foreground mb-2">Account Settings</h1>
      <p class="text-muted-foreground">
        Manage your account information and security settings
      </p>
    </div>

    <!-- Success/Error Messages -->
    <div id="message-container" class="mb-6 hidden">
      <div id="success-message" class="hidden p-4 rounded-md bg-green-50 border border-green-200 text-green-800">
        <p id="success-text"></p>
      </div>
      <div id="error-message" class="hidden p-4 rounded-md bg-red-50 border border-red-200 text-red-800">
        <p id="error-text"></p>
      </div>
    </div>

    <div class="space-y-6">
      <!-- Profile Information Card -->
      <div class="bg-card border border-border rounded-lg p-6">
        <h2 class="text-xl font-semibold text-foreground mb-4">Profile Information</h2>

        <form id="profile-form" class="space-y-4">
          <div>
            <label for="full_name" class="block text-sm font-medium text-foreground mb-2">
              Full Name
            </label>
            <input
              type="text"
              id="full_name"
              name="full_name"
              value={currentUser.full_name || ''}
              class="w-full px-3 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-texas-blue-500"
              placeholder="Enter your full name"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">
              Email Address
            </label>
            <p class="text-foreground">{currentUser.email}</p>
            <p class="text-xs text-muted-foreground mt-1">
              Contact support to change your email address
            </p>
          </div>

          <div>
            <label class="block text-sm font-medium text-muted-foreground mb-2">
              Account Type
            </label>
            <p class="text-foreground capitalize">{currentUser.role}</p>
          </div>

          <button
            type="submit"
            class="inline-flex items-center justify-center rounded-md bg-texas-blue-500 px-4 py-2 text-sm font-medium text-white hover:bg-texas-blue-600 focus:outline-none focus:ring-2 focus:ring-texas-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span class="button-text">Save Changes</span>
            <span class="loading-spinner hidden ml-2">
              <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
        </form>
      </div>

      <!-- Change Password Card -->
      <div class="bg-card border border-border rounded-lg p-6">
        <h2 class="text-xl font-semibold text-foreground mb-4">Change Password</h2>

        <form id="password-form" class="space-y-4">
          <div>
            <label for="current_password" class="block text-sm font-medium text-foreground mb-2">
              Current Password
            </label>
            <input
              type="password"
              id="current_password"
              name="current_password"
              class="w-full px-3 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-texas-blue-500"
              placeholder="Enter current password"
              required
            />
          </div>

          <div>
            <label for="new_password" class="block text-sm font-medium text-foreground mb-2">
              New Password
            </label>
            <input
              type="password"
              id="new_password"
              name="new_password"
              class="w-full px-3 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-texas-blue-500"
              placeholder="Enter new password (min 8 characters)"
              minlength="8"
              required
            />
            <p class="text-xs text-muted-foreground mt-1">
              Password must be at least 8 characters long
            </p>
          </div>

          <div>
            <label for="confirm_password" class="block text-sm font-medium text-foreground mb-2">
              Confirm New Password
            </label>
            <input
              type="password"
              id="confirm_password"
              name="confirm_password"
              class="w-full px-3 py-2 border border-input rounded-md bg-background text-foreground focus:outline-none focus:ring-2 focus:ring-texas-blue-500"
              placeholder="Confirm new password"
              minlength="8"
              required
            />
          </div>

          <button
            type="submit"
            class="inline-flex items-center justify-center rounded-md bg-texas-blue-500 px-4 py-2 text-sm font-medium text-white hover:bg-texas-blue-600 focus:outline-none focus:ring-2 focus:ring-texas-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span class="button-text">Update Password</span>
            <span class="loading-spinner hidden ml-2">
              <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
          </button>
        </form>
      </div>

      <!-- Danger Zone -->
      <div class="bg-card border border-red-200 rounded-lg p-6">
        <h2 class="text-xl font-semibold text-red-600 mb-2">Danger Zone</h2>
        <p class="text-sm text-muted-foreground mb-4">
          Once you delete your account, there is no going back. Please be certain.
        </p>

        <button
          type="button"
          id="delete-account-btn"
          class="inline-flex items-center justify-center rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500"
        >
          Delete Account
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Account Confirmation Modal -->
  <div id="delete-modal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-md w-full p-6">
      <h3 class="text-xl font-semibold text-foreground mb-4">Delete Account</h3>
      <p class="text-muted-foreground mb-6">
        Are you sure you want to delete your account? This action cannot be undone. All your data will be permanently removed.
      </p>

      <div class="flex gap-3 justify-end">
        <button
          id="cancel-delete-btn"
          class="px-4 py-2 text-sm font-medium text-foreground border border-border rounded-md hover:bg-accent"
        >
          Cancel
        </button>
        <button
          id="confirm-delete-btn"
          class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700"
        >
          Delete Account
        </button>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Helper functions
  function showMessage(type: 'success' | 'error', message: string) {
    const container = document.getElementById('message-container');
    const successDiv = document.getElementById('success-message');
    const errorDiv = document.getElementById('error-message');
    const successText = document.getElementById('success-text');
    const errorText = document.getElementById('error-text');

    if (!container || !successDiv || !errorDiv || !successText || !errorText) return;

    // Hide both messages first
    successDiv.classList.add('hidden');
    errorDiv.classList.add('hidden');
    container.classList.remove('hidden');

    if (type === 'success') {
      successText.textContent = message;
      successDiv.classList.remove('hidden');
    } else {
      errorText.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    // Scroll to top to show message
    window.scrollTo({ top: 0, behavior: 'smooth' });

    // Auto-hide after 5 seconds
    setTimeout(() => {
      container.classList.add('hidden');
    }, 5000);
  }

  function setButtonLoading(button: HTMLButtonElement, loading: boolean) {
    const text = button.querySelector('.button-text');
    const spinner = button.querySelector('.loading-spinner');

    if (loading) {
      button.disabled = true;
      spinner?.classList.remove('hidden');
    } else {
      button.disabled = false;
      spinner?.classList.add('hidden');
    }
  }

  // Profile Form Handler
  const profileForm = document.getElementById('profile-form') as HTMLFormElement;
  profileForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = profileForm.querySelector('button[type="submit"]') as HTMLButtonElement;
    setButtonLoading(submitBtn, true);

    const formData = new FormData(profileForm);
    const full_name = formData.get('full_name') as string;

    try {
      const response = await fetch('/api/account/update-profile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ full_name }),
      });

      const data = await response.json();

      if (response.ok) {
        showMessage('success', 'Profile updated successfully!');
      } else {
        showMessage('error', data.error || 'Failed to update profile');
      }
    } catch (error) {
      showMessage('error', 'An error occurred. Please try again.');
    } finally {
      setButtonLoading(submitBtn, false);
    }
  });

  // Password Form Handler
  const passwordForm = document.getElementById('password-form') as HTMLFormElement;
  passwordForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = passwordForm.querySelector('button[type="submit"]') as HTMLButtonElement;
    setButtonLoading(submitBtn, true);

    const formData = new FormData(passwordForm);
    const current_password = formData.get('current_password') as string;
    const new_password = formData.get('new_password') as string;
    const confirm_password = formData.get('confirm_password') as string;

    // Validate passwords match
    if (new_password !== confirm_password) {
      showMessage('error', 'New passwords do not match');
      setButtonLoading(submitBtn, false);
      return;
    }

    // Validate password length
    if (new_password.length < 8) {
      showMessage('error', 'Password must be at least 8 characters long');
      setButtonLoading(submitBtn, false);
      return;
    }

    try {
      const response = await fetch('/api/account/update-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ current_password, new_password }),
      });

      const data = await response.json();

      if (response.ok) {
        showMessage('success', 'Password updated successfully!');
        passwordForm.reset();
      } else {
        showMessage('error', data.error || 'Failed to update password');
      }
    } catch (error) {
      showMessage('error', 'An error occurred. Please try again.');
    } finally {
      setButtonLoading(submitBtn, false);
    }
  });

  // Delete Account Modal Handlers
  const deleteBtn = document.getElementById('delete-account-btn');
  const deleteModal = document.getElementById('delete-modal');
  const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
  const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

  deleteBtn?.addEventListener('click', () => {
    deleteModal?.classList.remove('hidden');
  });

  cancelDeleteBtn?.addEventListener('click', () => {
    deleteModal?.classList.add('hidden');
  });

  confirmDeleteBtn?.addEventListener('click', async () => {
    try {
      const response = await fetch('/api/account/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
      });

      if (response.ok) {
        // Redirect to homepage after successful deletion
        window.location.href = '/?message=account-deleted';
      } else {
        const data = await response.json();
        showMessage('error', data.error || 'Failed to delete account');
        deleteModal?.classList.add('hidden');
      }
    } catch (error) {
      showMessage('error', 'An error occurred. Please try again.');
      deleteModal?.classList.add('hidden');
    }
  });

  // Close modal on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !deleteModal?.classList.contains('hidden')) {
      deleteModal?.classList.add('hidden');
    }
  });
</script>
