---
import Layout from '@/components/astro/Layout.astro';
import { createServerClient } from '@/lib/supabase';

// Require admin
const user = Astro.locals.user;
if (!user) return Astro.redirect('/login?redirect=' + Astro.url.pathname);
if (user.role !== 'admin') return Astro.redirect('/dashboard');

const serverClient = createServerClient();

// Get all audit logs (paginated)
const { data: auditLogs } = await serverClient
  .from('admin_audit_log')
  .select('*')
  .order('created_at', { ascending: false })
  .limit(100);

const pageTitle = 'Audit Log | Admin';
---

<Layout title={pageTitle} description="View all administrative actions">
  <section class="py-12">
    <div class="container max-w-7xl">
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-3xl font-bold mb-2">Audit Log</h1>
          <p class="text-muted-foreground">Complete history of all administrative actions</p>
        </div>
        <a href="/admin" class="text-texas-blue-500 hover:underline">‚Üê Back to Admin</a>
      </div>

      <!-- Filters -->
      <div class="mb-6 space-y-4">
        <div class="flex gap-4">
          <div class="flex-1">
            <input
              type="text"
              id="search-input"
              placeholder="Search by admin, user, or description..."
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-texas-blue-500 focus:border-transparent"
            />
          </div>
          <select
            id="action-filter"
            class="px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-texas-blue-500 focus:border-transparent"
          >
            <option value="">All Actions</option>
            <option value="user_created">User Created</option>
            <option value="user_updated">User Updated</option>
            <option value="user_deleted">User Deleted</option>
            <option value="user_promoted">User Promoted</option>
            <option value="user_suspended">User Suspended</option>
            <option value="user_unsuspended">User Unsuspended</option>
            <option value="profile_approved">Profile Approved</option>
            <option value="profile_rejected">Profile Rejected</option>
          </select>
        </div>
        <div class="flex items-center justify-between text-sm text-muted-foreground">
          <span id="results-count">{auditLogs?.length || 0} entries (showing last 100)</span>
          <button
            id="clear-filters"
            class="text-texas-blue-600 hover:text-texas-blue-700 font-medium"
          >
            Clear Filters
          </button>
        </div>
      </div>

      <!-- Audit Log Table -->
      <div class="rounded-lg border border-border bg-white overflow-hidden">
        {!auditLogs || auditLogs.length === 0 ? (
          <div class="px-6 py-12 text-center text-muted-foreground">
            <p>No audit log entries found.</p>
          </div>
        ) : (
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-border">
              <thead class="bg-muted">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Timestamp</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Admin</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Action</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Target User</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Description</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Details</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                {auditLogs.map((log) => (
                  <tr
                    class="hover:bg-muted/50 audit-row"
                    data-admin={log.admin_email}
                    data-target={log.target_user_email || ''}
                    data-action={log.action_type}
                    data-description={log.action_description}
                  >
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                      <div>
                        {new Date(log.created_at).toLocaleDateString('en-US', {
                          month: 'short',
                          day: 'numeric',
                          year: 'numeric'
                        })}
                      </div>
                      <div class="text-xs">
                        {new Date(log.created_at).toLocaleTimeString('en-US', {
                          hour: '2-digit',
                          minute: '2-digit'
                        })}
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <div class="text-sm font-medium">{log.admin_email}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class={`inline-flex rounded-full px-2 py-1 text-xs font-semibold ${
                        log.action_type.includes('deleted') || log.action_type.includes('rejected') ? 'bg-red-100 text-red-800' :
                        log.action_type.includes('suspended') ? 'bg-orange-100 text-orange-800' :
                        log.action_type.includes('approved') || log.action_type.includes('unsuspended') ? 'bg-green-100 text-green-800' :
                        log.action_type.includes('promoted') ? 'bg-purple-100 text-purple-800' :
                        'bg-blue-100 text-blue-800'
                      }`}>
                        {log.action_type.replace(/_/g, ' ')}
                      </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      {log.target_user_email || <span class="text-muted-foreground italic">N/A</span>}
                    </td>
                    <td class="px-6 py-4 text-sm max-w-md">
                      <div class="truncate" title={log.action_description}>
                        {log.action_description}
                      </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      {log.action_metadata && (
                        <button
                          class="view-metadata-btn text-texas-blue-600 hover:text-texas-blue-700 font-medium"
                          data-metadata={JSON.stringify(log.action_metadata, null, 2)}
                        >
                          View Details
                        </button>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  </section>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Search and filter functionality
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const actionFilter = document.getElementById('action-filter') as HTMLSelectElement;
    const clearFiltersBtn = document.getElementById('clear-filters') as HTMLButtonElement;
    const resultsCount = document.getElementById('results-count') as HTMLSpanElement;
    const auditRows = document.querySelectorAll('.audit-row') as NodeListOf<HTMLElement>;

    function filterLogs() {
      const searchTerm = searchInput.value.toLowerCase();
      const actionValue = actionFilter.value.toLowerCase();

      let visibleCount = 0;

      auditRows.forEach(row => {
        const admin = row.dataset.admin?.toLowerCase() || '';
        const target = row.dataset.target?.toLowerCase() || '';
        const action = row.dataset.action?.toLowerCase() || '';
        const description = row.dataset.description?.toLowerCase() || '';

        // Check search term
        const matchesSearch = !searchTerm ||
          admin.includes(searchTerm) ||
          target.includes(searchTerm) ||
          description.includes(searchTerm);

        // Check action filter
        const matchesAction = !actionValue || action === actionValue;

        // Show/hide row
        if (matchesSearch && matchesAction) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });

      // Update results count
      resultsCount.textContent = `${visibleCount} entr${visibleCount !== 1 ? 'ies' : 'y'}`;
    }

    function clearFilters() {
      searchInput.value = '';
      actionFilter.value = '';
      filterLogs();
    }

    searchInput.addEventListener('input', filterLogs);
    actionFilter.addEventListener('change', filterLogs);
    clearFiltersBtn.addEventListener('click', clearFilters);

    // View metadata modal
    const metadataButtons = document.querySelectorAll('.view-metadata-btn');
    metadataButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        const target = e.target as HTMLButtonElement;
        const metadata = target.dataset.metadata;

        if (metadata) {
          alert(`Action Details:\\n\\n${metadata}`);
        }
      });
    });
  });
</script>
