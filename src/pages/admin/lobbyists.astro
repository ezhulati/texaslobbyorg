---
import Layout from '@/components/astro/Layout.astro';

import { createServerClient } from '@/lib/supabase';
const serverClient = createServerClient();

// Require admin
const user = Astro.locals.user;
if (!user) return Astro.redirect('/login?redirect=' + Astro.url.pathname);

// Role check using middleware
if (user.role !== 'admin') return Astro.redirect('/dashboard');

// Get all lobbyists
const { data: lobbyists } = await serverClient
  .from('lobbyists')
  .select('*')
  .order('created_at', { ascending: false });

const pageTitle = 'Manage Lobbyists | Admin';
---

<Layout title={pageTitle} description="Manage all lobbyist profiles">
  <section class="py-12">
    <div class="container max-w-6xl">
      <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold">Manage Lobbyists</h1>
        <a href="/admin" class="text-texas-blue-500 hover:underline">‚Üê Back to Admin</a>
      </div>

      <div class="rounded-lg border border-border bg-white overflow-hidden">
        <table class="min-w-full divide-y divide-border">
          <thead class="bg-muted">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Tier</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Created</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            {lobbyists?.map((lobbyist) => (
              <tr class="hover:bg-muted/50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="font-medium">{lobbyist.first_name} {lobbyist.last_name}</div>
                  <div class="text-sm text-muted-foreground">{lobbyist.email}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={`inline-flex rounded-full px-2 text-xs font-semibold ${
                    lobbyist.is_pending ? 'bg-amber-100 text-amber-800' :
                    lobbyist.is_active ? 'bg-green-100 text-green-800' :
                    'bg-gray-100 text-gray-800'
                  }`}>
                    {lobbyist.is_pending ? 'Pending' : lobbyist.is_active ? 'Active' : 'Inactive'}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  {lobbyist.subscription_tier || 'free'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                  {new Date(lobbyist.created_at).toLocaleDateString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                  <a href={`/lobbyists/${lobbyist.slug}`} class="text-texas-blue-500 hover:underline">View</a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </section>
</Layout>
