---
import Layout from '@/components/astro/Layout.astro';

import { createServerClient } from '@/lib/supabase';
const serverClient = createServerClient();

// Require admin
const user = Astro.locals.user;
if (!user) return Astro.redirect('/login?redirect=' + Astro.url.pathname);

// Role check using middleware
if (user.role !== 'admin') return Astro.redirect('/dashboard');

// Get all users
const { data: users } = await supabase
  .from('users')
  .select('*')
  .order('created_at', { ascending: false });

const pageTitle = 'Manage Users | Admin';
---

<Layout title={pageTitle} description="Manage all users">
  <section class="py-12">
    <div class="container max-w-6xl">
      <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold">Manage Users</h1>
        <a href="/admin" class="text-texas-blue-500 hover:underline">‚Üê Back to Admin</a>
      </div>

      <div class="rounded-lg border border-border bg-white overflow-hidden">
        <table class="min-w-full divide-y divide-border">
          <thead class="bg-muted">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Role</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Created</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            {users?.map((u) => (
              <tr class="hover:bg-muted/50">
                <td class="px-6 py-4 whitespace-nowrap font-medium">
                  {u.full_name || 'N/A'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                  {u.email}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={`inline-flex rounded-full px-2 text-xs font-semibold ${
                    u.role === 'admin' ? 'bg-purple-100 text-purple-800' :
                    u.role === 'lobbyist' ? 'bg-blue-100 text-blue-800' :
                    'bg-gray-100 text-gray-800'
                  }`}>
                    {u.role || 'searcher'}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                  {new Date(u.created_at).toLocaleDateString()}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </section>
</Layout>
