---
import Layout from '@/components/astro/Layout.astro';

import { createServerClient } from '@/lib/supabase';
const serverClient = createServerClient();

// Require admin
const user = Astro.locals.user;
if (!user) return Astro.redirect('/login?redirect=' + Astro.url.pathname);

// Role check using middleware
if (user.role !== 'admin') return Astro.redirect('/dashboard');

// Get all users
const { data: users } = await serverClient
  .from('users')
  .select('*')
  .order('created_at', { ascending: false });

const pageTitle = 'Manage Users | Admin';
---

<Layout title={pageTitle} description="Manage all users">
  <section class="py-12">
    <div class="container max-w-6xl">
      <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold">Manage Users</h1>
        <a href="/admin" class="text-texas-blue-500 hover:underline">← Back to Admin</a>
      </div>

      <div class="rounded-lg border border-border bg-white overflow-hidden">
        <table class="min-w-full divide-y divide-border">
          <thead class="bg-muted">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Role</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase">Created</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            {users?.map((u) => (
              <tr class="hover:bg-muted/50">
                <td class="px-6 py-4 whitespace-nowrap font-medium">
                  {u.full_name || 'N/A'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                  {u.email}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class={`inline-flex rounded-full px-2 text-xs font-semibold ${
                    u.role === 'admin' ? 'bg-purple-100 text-purple-800' :
                    u.role === 'lobbyist' ? 'bg-blue-100 text-blue-800' :
                    'bg-gray-100 text-gray-800'
                  }`}>
                    {u.role || 'searcher'}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-muted-foreground">
                  {new Date(u.created_at).toLocaleDateString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                  {u.role !== 'admin' && (
                    <button
                      data-user-id={u.id}
                      data-user-name={u.full_name || u.email}
                      class="promote-admin-btn text-purple-600 hover:text-purple-800 font-medium"
                    >
                      Promote to Admin
                    </button>
                  )}
                  {u.role === 'admin' && u.id === user.id && (
                    <span class="text-xs text-muted-foreground italic">You</span>
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </section>
</Layout>

<script>
  // Handle promote to admin button clicks
  document.addEventListener('DOMContentLoaded', () => {
    const promoteButtons = document.querySelectorAll('.promote-admin-btn');

    promoteButtons.forEach(button => {
      button.addEventListener('click', async (e) => {
        const target = e.target as HTMLButtonElement;
        const userId = target.dataset.userId;
        const userName = target.dataset.userName;

        if (!userId) return;

        // Confirm promotion
        const confirmed = confirm(
          `Are you sure you want to promote "${userName}" to admin?\n\n` +
          `This will give them full access to:\n` +
          `• Approve/reject profiles\n` +
          `• Manage all users\n` +
          `• Access all admin features`
        );

        if (!confirmed) return;

        // Disable button
        target.disabled = true;
        target.textContent = 'Promoting...';

        try {
          const response = await fetch('/api/admin/promote-user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({ userId }),
          });

          const data = await response.json();

          if (response.ok) {
            alert(`✓ ${userName} has been promoted to admin!`);
            window.location.reload();
          } else {
            alert(`Failed to promote user: ${data.error || 'Unknown error'}`);
            target.disabled = false;
            target.textContent = 'Promote to Admin';
          }
        } catch (error) {
          alert('An error occurred. Please try again.');
          target.disabled = false;
          target.textContent = 'Promote to Admin';
        }
      });
    });
  });
</script>
