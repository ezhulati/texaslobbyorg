---
import Layout from '@/components/astro/Layout.astro';
import { createServerClient } from '@/lib/supabase';

// Require admin
const user = Astro.locals.user;
if (!user) return Astro.redirect('/login?redirect=' + Astro.url.pathname);
if (user.role !== 'admin') return Astro.redirect('/dashboard');

const { id: targetUserId } = Astro.params;

if (!targetUserId) {
  return Astro.redirect('/admin/users');
}

const serverClient = createServerClient();

// Get target user details
const { data: targetUser } = await serverClient
  .from('users')
  .select('*')
  .eq('id', targetUserId)
  .single();

if (!targetUser) {
  return Astro.redirect('/admin/users');
}

const pageTitle = `Edit User - ${targetUser.full_name || targetUser.email}`;
---

<Layout title={pageTitle} description="Edit user information">
  <section class="py-12">
    <div class="container max-w-2xl">
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-3xl font-bold mb-2">Edit User</h1>
          <p class="text-muted-foreground">Update user account information</p>
        </div>
        <a href={`/admin/users/${targetUserId}`} class="text-texas-blue-500 hover:underline">← Back to User</a>
      </div>

      <!-- Edit Form -->
      <div class="rounded-lg border bg-white p-8">
        <form id="edit-user-form" class="space-y-6">
          <!-- Full Name -->
          <div>
            <label for="full_name" class="block text-sm font-medium text-gray-700 mb-2">
              Full Name
            </label>
            <input
              type="text"
              id="full_name"
              name="full_name"
              value={targetUser.full_name || ''}
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-texas-blue-500 focus:border-transparent"
              placeholder="John Doe"
            />
          </div>

          <!-- Email -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
              Email Address <span class="text-red-500">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              value={targetUser.email}
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-texas-blue-500 focus:border-transparent"
              placeholder="john@example.com"
            />
            <p class="mt-1 text-sm text-muted-foreground">
              Changing email may affect user's ability to sign in
            </p>
          </div>

          <!-- Role -->
          <div>
            <label for="role" class="block text-sm font-medium text-gray-700 mb-2">
              Role <span class="text-red-500">*</span>
            </label>
            <select
              id="role"
              name="role"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-texas-blue-500 focus:border-transparent"
            >
              <option value="searcher" selected={targetUser.role === 'searcher' || !targetUser.role}>Searcher</option>
              <option value="lobbyist" selected={targetUser.role === 'lobbyist'}>Lobbyist</option>
              <option value="admin" selected={targetUser.role === 'admin'}>Admin</option>
            </select>
            <p class="mt-1 text-sm text-muted-foreground">
              Admins have full access to all administrative features
            </p>
          </div>

          <!-- User ID (Read-only) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              User ID
            </label>
            <input
              type="text"
              value={targetUser.id}
              disabled
              class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500 font-mono text-sm"
            />
          </div>

          <!-- Created At (Read-only) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Account Created
            </label>
            <input
              type="text"
              value={new Date(targetUser.created_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}
              disabled
              class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500"
            />
          </div>

          <!-- Error Message -->
          <div id="error-message" class="hidden rounded-lg border border-red-200 bg-red-50 p-4">
            <p class="text-sm text-red-800"></p>
          </div>

          <!-- Success Message -->
          <div id="success-message" class="hidden rounded-lg border border-green-200 bg-green-50 p-4">
            <p class="text-sm text-green-800">User information updated successfully!</p>
          </div>

          <!-- Actions -->
          <div class="flex gap-4 pt-4">
            <button
              type="submit"
              id="submit-btn"
              class="flex-1 px-6 py-3 bg-texas-blue-600 text-white font-medium rounded-md hover:bg-texas-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-texas-blue-500"
            >
              Save Changes
            </button>
            <a
              href={`/admin/users/${targetUserId}`}
              class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-md hover:bg-gray-50 text-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-texas-blue-500"
            >
              Cancel
            </a>
          </div>
        </form>
      </div>

      <!-- Warning -->
      <div class="mt-6 rounded-lg border border-yellow-200 bg-yellow-50 p-4">
        <div class="flex items-start gap-3">
          <svg class="h-5 w-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
          <div class="flex-1">
            <h4 class="text-sm font-semibold text-yellow-900 mb-1">Important Notes</h4>
            <ul class="text-sm text-yellow-800 space-y-1">
              <li>• Changing the email may prevent the user from signing in with their old credentials</li>
              <li>• Demoting the last admin account is not allowed</li>
              <li>• All changes are logged in the audit trail</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script define:vars={{ targetUserId }}>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('edit-user-form');
    const submitBtn = document.getElementById('submit-btn');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Hide messages
      errorMessage?.classList.add('hidden');
      successMessage?.classList.add('hidden');

      // Get form data
      const formData = new FormData(form);
      const full_name = formData.get('full_name')?.toString() || null;
      const email = formData.get('email')?.toString();
      const role = formData.get('role')?.toString();

      // Validate
      if (!email) {
        showError('Email is required');
        return;
      }

      if (!role) {
        showError('Role is required');
        return;
      }

      // Disable button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Saving...';

      try {
        const response = await fetch('/api/admin/edit-user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            userId: targetUserId,
            full_name,
            email,
            role
          }),
        });

        const data = await response.json();

        if (response.ok) {
          successMessage?.classList.remove('hidden');
          setTimeout(() => {
            window.location.href = `/admin/users/${targetUserId}`;
          }, 1500);
        } else {
          showError(data.error || 'Failed to update user information');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Save Changes';
        }
      } catch (error) {
        showError('An error occurred. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Changes';
      }
    });

    function showError(message) {
      const errorText = errorMessage?.querySelector('p');
      if (errorText) errorText.textContent = message;
      errorMessage?.classList.remove('hidden');
    }
  });
</script>
