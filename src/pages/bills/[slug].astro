---
/**
 * Bill Detail Page
 *
 * Displays complete information about a specific bill.
 */

import Layout from '@/components/astro/Layout.astro';
import BillDetailLayout from '@/components/astro/bills/BillDetailLayout.astro';
import BillUpdateTimeline from '@/components/astro/bills/BillUpdateTimeline.astro';
import LobbyistCard from '@/components/astro/bills/LobbyistCard.astro';
import WatchlistButton from '@/components/react/bills/WatchlistButton';
import BillTagButton from '@/components/react/bills/BillTagButton';
import { createServerClient } from '@/lib/supabase';
import { getBillBySlug, getBillUpdates, getBillTags } from '@/lib/api/bills';

// Get bill slug from URL
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/bills');
}

// Fetch bill data
const bill = await getBillBySlug(slug);

if (!bill) {
  return Astro.redirect('/bills?error=not-found');
}

// Fetch bill update history
const updates = await getBillUpdates(bill.id);

// Fetch bill tags (lobbyists tracking this bill)
const billTags = await getBillTags(bill.id);
const publicTags = billTags.filter((tag: any) => tag.is_public);

// Get authentication state
const isAuthenticated = Astro.locals.isAuthenticated || false;
const currentUser = Astro.locals.user;
const isLobbyist = currentUser?.role === 'lobbyist';

// Resolve lobbyistId for current user (server-side)
let lobbyistId: string | null = null;
if (isLobbyist && currentUser?.id) {
  try {
    const serverClient = createServerClient();
    const { data } = await serverClient
      .from('lobbyists')
      .select('id')
      .or(`user_id.eq.${currentUser.id},claimed_by.eq.${currentUser.id}`)
      .limit(1)
      .maybeSingle();
    lobbyistId = data?.id || null;
  } catch (e) {
    lobbyistId = null;
  }
}

// Increment view count (fire and forget)
try {
  await fetch(`${Astro.url.origin}/api/bills/${bill.id}/increment-views`, {
    method: 'POST',
  });
} catch (error) {
  // Silently fail - view count is non-critical
  console.error('Failed to increment view count:', error);
}

// Use SEO-optimized fields if available, otherwise fallback to defaults
const pageTitle = bill.title_tag || `${bill.bill_number} - ${bill.title}`;
const pageDescription = bill.meta_description || bill.summary || bill.title.substring(0, 160);
const pageExcerpt = bill.excerpt || bill.summary?.substring(0, 150);
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    {/* Breadcrumb */}
    <nav class="mb-8 text-sm text-gray-600" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2">
        <li>
          <a href="/bills" class="hover:text-blue-600">
            Bills
          </a>
        </li>
        <li>
          <span class="mx-2">/</span>
        </li>
        <li class="text-gray-900 font-medium">
          {bill.bill_number}
        </li>
      </ol>
    </nav>

    {/* Bill Details */}
    <BillDetailLayout bill={bill} introHook={bill.intro_hook}>
      <div slot="actions" class="flex flex-wrap items-center gap-3">
        <a
          href="/bills"
          class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md text-gray-700 font-medium hover:bg-gray-50 transition-colors"
        >
          ‚Üê Back to Bills
        </a>

        <WatchlistButton
          client:load
          billId={bill.id}
          billNumber={bill.bill_number}
          isAuthenticated={isAuthenticated}
        />

        <BillTagButton
          client:load
          billId={bill.id}
          billNumber={bill.bill_number}
          isAuthenticated={isAuthenticated}
          isLobbyist={isLobbyist}
          lobbyistId={lobbyistId}
        />
      </div>
      {/* Lobbyists Section */}
      {publicTags && publicTags.length > 0 && (
        <div class="mt-12 pt-12 border-t border-gray-200">
          <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">
              Lobbyists Working on This Bill
            </h2>
            <p class="text-gray-600">
              Connect with experienced lobbyists who are tracking or working on this legislation.
            </p>
          </div>
          <div class="grid gap-4">
            {publicTags.map((tag: any) => (
              <LobbyistCard lobbyist={tag.lobbyist} tag={tag} />
            ))}
          </div>
        </div>
      )}

      {/* Update Timeline - Only show if there are meaningful updates (not just placeholder filed entries) */}
      {updates && updates.length > 0 && !updates.every((u: any) => u.update_type === 'filed' && u.description?.includes('Not yet available')) && (
        <div class="mt-12 pt-12 border-t border-gray-200">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">
            Bill History
          </h2>
          <BillUpdateTimeline updates={updates} />
        </div>
      )}

      {bill.full_text_url && (
        <div class="mt-12 pt-12 border-t border-gray-200">
          <a
            href={bill.full_text_url}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors"
          >
            View on Texas Legislature
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          </a>
        </div>
      )}

      {/* Related Guides */}
      <div class="mt-12 pt-12 border-t border-gray-200">
        <div class="mb-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-2">
            Related Guides
          </h2>
          <p class="text-gray-600">
            Learn more about tracking Texas legislation and working with lobbyists.
          </p>
        </div>
        <div class="grid gap-6 md:grid-cols-2">
          <a
            href="/guides/how-to-read-track-texas-bills"
            class="group p-6 bg-white border border-gray-200 rounded-lg hover:border-blue-600 hover:shadow-md transition-all"
          >
            <h3 class="text-lg font-semibold text-gray-900 group-hover:text-blue-600 mb-2">
              How to Read & Track Texas Bills
            </h3>
            <p class="text-gray-600 text-sm">
              Master bill numbering, understand legislative language, and learn effective tracking strategies.
            </p>
          </a>

          <a
            href="/guides/understanding-texas-legislative-deadlines"
            class="group p-6 bg-white border border-gray-200 rounded-lg hover:border-blue-600 hover:shadow-md transition-all"
          >
            <h3 class="text-lg font-semibold text-gray-900 group-hover:text-blue-600 mb-2">
              Understanding Texas Legislative Deadlines
            </h3>
            <p class="text-gray-600 text-sm">
              Navigate the 140-day session with critical calendar dates and filing deadlines.
            </p>
          </a>

          <a
            href="/guides/how-laws-get-made-in-texas"
            class="group p-6 bg-white border border-gray-200 rounded-lg hover:border-blue-600 hover:shadow-md transition-all"
          >
            <h3 class="text-lg font-semibold text-gray-900 group-hover:text-blue-600 mb-2">
              How Laws Get Made in Texas
            </h3>
            <p class="text-gray-600 text-sm">
              Follow a bill's journey from filing to the governor's desk through committees and floor votes.
            </p>
          </a>

          <a
            href="/guides/when-should-your-business-hire-a-lobbyist"
            class="group p-6 bg-white border border-gray-200 rounded-lg hover:border-blue-600 hover:shadow-md transition-all"
          >
            <h3 class="text-lg font-semibold text-gray-900 group-hover:text-blue-600 mb-2">
              When Should Your Business Hire a Lobbyist?
            </h3>
            <p class="text-gray-600 text-sm">
              Discover the signs that your business needs professional advocacy at the Texas Capitol.
            </p>
          </a>
        </div>
      </div>
    </BillDetailLayout>
  </div>
</Layout>
