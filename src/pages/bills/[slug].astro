---
/**
 * Bill Detail Page
 *
 * Displays complete information about a specific bill.
 */

import Layout from '@/components/astro/Layout.astro';
import BillDetailLayout from '@/components/astro/bills/BillDetailLayout.astro';
import BillUpdateTimeline from '@/components/astro/bills/BillUpdateTimeline.astro';
import { getBillBySlug, getBillUpdates } from '@/lib/api/bills';

// Get bill slug from URL
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/bills');
}

// Fetch bill data
const bill = await getBillBySlug(slug);

if (!bill) {
  return Astro.redirect('/bills?error=not-found');
}

// Fetch bill update history
const updates = await getBillUpdates(bill.id);

// Increment view count (fire and forget)
try {
  await fetch(`${Astro.url.origin}/api/bills/${bill.id}/increment-views`, {
    method: 'POST',
  });
} catch (error) {
  // Silently fail - view count is non-critical
  console.error('Failed to increment view count:', error);
}

const pageTitle = `${bill.bill_number} - ${bill.title}`;
const pageDescription = bill.summary || bill.title.substring(0, 160);
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    {/* Breadcrumb */}
    <nav class="mb-8 text-sm text-gray-600" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2">
        <li>
          <a href="/bills" class="hover:text-blue-600">
            Bills
          </a>
        </li>
        <li>
          <span class="mx-2">/</span>
        </li>
        <li class="text-gray-900 font-medium">
          {bill.bill_number}
        </li>
      </ol>
    </nav>

    {/* Bill Details */}
    <BillDetailLayout bill={bill}>
      {/* Update Timeline */}
      {updates && updates.length > 0 && (
        <div class="mt-12 pt-12 border-t border-gray-200">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">
            Bill History
          </h2>
          <BillUpdateTimeline updates={updates} />
        </div>
      )}

      {/* Actions */}
      <div class="mt-12 pt-12 border-t border-gray-200">
        <div class="flex flex-wrap gap-4">
          <a
            href="/bills"
            class="inline-flex items-center px-6 py-3 border border-gray-300 rounded-md text-gray-700 font-medium hover:bg-gray-50 transition-colors"
          >
            ‚Üê Back to Bills
          </a>

          {bill.full_text_url && (
            <a
              href={bill.full_text_url}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors"
            >
              View on Texas Legislature
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
          )}
        </div>
      </div>
    </BillDetailLayout>
  </div>
</Layout>
