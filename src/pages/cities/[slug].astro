---
import Layout from '@/components/astro/Layout.astro';
import SearchableList from '@/components/react/SearchableList';
import { supabase } from '@/lib/supabase';

const { slug } = Astro.params;

// Get city data
const { data: city, error: cityError } = await supabase
  .from('cities')
  .select('*')
  .eq('slug', slug)
  .single();

if (cityError || !city) {
  return Astro.redirect('/404');
}

// Get lobbyists serving this city (use city NAME not slug)
const { data: lobbyists } = await supabase
  .from('lobbyists')
  .select('*')
  .contains('cities', [city.name])
  .eq('is_active', true)
  .order('subscription_tier', { ascending: false })
  .order('view_count', { ascending: false });

// Get all subject areas for filtering
const { data: subjects } = await supabase
  .from('subject_areas')
  .select('slug, name')
  .order('name');

// Get subject area distribution for this city
const subjectCounts: Record<string, number> = {};
lobbyists?.forEach((lobbyist) => {
  lobbyist.subject_areas?.forEach((subject: string) => {
    subjectCounts[subject] = (subjectCounts[subject] || 0) + 1;
  });
});

const topSubjects = Object.entries(subjectCounts)
  .sort(([, a], [, b]) => b - a)
  .slice(0, 5);

const featuredCount = lobbyists?.filter((l) => l.subscription_tier === 'featured').length || 0;
const premiumCount = lobbyists?.filter((l) => l.subscription_tier === 'premium').length || 0;

// Build SEO-optimized title (55-60 chars)
const lobbyistCount = lobbyists?.length || 0;
const countyText = city.county ? ` ${city.county} County` : '';
let pageTitle = city.meta_title;
if (!pageTitle) {
  // Format: "Austin Lobbyists | 150+ Texas Political Advocates"
  const countText = lobbyistCount > 0 ? `${lobbyistCount}+ ` : '';
  pageTitle = `${city.name} Lobbyists | ${countText}Texas Political Advocates`;
  // If too long, simplify
  if (pageTitle.length > 60) {
    pageTitle = `${city.name} Texas Lobbyists | Find Political Advocates`;
  }
}

// Build SEO-optimized description (155-160 chars max)
let pageDescription = city.meta_description;
if (!pageDescription) {
  const countText = lobbyistCount > 0 ? `${lobbyistCount}+ ` : '';
  const countyCtx = city.county ? ` in ${city.county} County` : '';
  pageDescription = `Find ${countText}experienced Texas lobbyists serving ${city.name}${countyCtx}. Compare profiles, review expertise areas, client lists, and connect directly.`;
  // Ensure it doesn't exceed 160 chars
  if (pageDescription.length > 160) {
    pageDescription = pageDescription.substring(0, 157) + '...';
  }
}
---

<Layout title={pageTitle} description={pageDescription}>
  <!-- City Header -->
  <section class="bg-texas-blue-500 text-white py-16">
    <div class="container">
      <div class="max-w-4xl">
        <div class="flex items-center gap-3 mb-4">
          <a href="/cities" class="text-white/80 hover:text-white text-sm">All Cities</a>
          <svg class="h-4 w-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"
            ></path>
          </svg>
          <span class="text-sm">{city.name}</span>
        </div>
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          Lobbyists Serving {city.name}
        </h1>
        <p class="text-xl text-white/90 mb-6">
          {lobbyists?.length || 0} experienced lobbyists ready to represent your interests in {
            city.name
          }
          {city.county && ` (${city.county} County)`}
        </p>

        {/* City Stats */}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <div class="text-2xl font-bold">{lobbyists?.length || 0}</div>
            <div class="text-sm text-white/80">Lobbyists</div>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <div class="text-2xl font-bold">{featuredCount + premiumCount}</div>
            <div class="text-sm text-white/80">Premium</div>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <div class="text-2xl font-bold">{Object.keys(subjectCounts).length}</div>
            <div class="text-sm text-white/80">Expertise Areas</div>
          </div>
          {
            city.population && (
              <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                <div class="text-2xl font-bold">
                  {(city.population / 1000000).toFixed(1)}M
                </div>
                <div class="text-sm text-white/80">Population</div>
              </div>
            )
          }
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-12">
    <div class="container">
      <div class="grid lg:grid-cols-4 gap-8">
        <!-- Sidebar Filters -->
        <div class="lg:col-span-1">
          <div class="sticky top-6 space-y-6">
            <!-- Subject Areas Filter -->
            <div class="rounded-lg border border-border bg-white p-6">
              <h3 class="font-semibold mb-4">Filter by Expertise</h3>
              <div class="space-y-2">
                <a
                  href={`/cities/${slug}`}
                  class="block text-sm py-2 px-3 rounded hover:bg-muted transition-colors"
                >
                  All Areas ({lobbyists?.length || 0})
                </a>
                {subjects?.map((subject) => {
                  const count = subjectCounts[subject.name] || 0;
                  if (count === 0) return null;
                  return (
                    <a
                      href={`/cities/${slug}?subject=${subject.slug}`}
                      class="block text-sm py-2 px-3 rounded hover:bg-muted transition-colors"
                    >
                      {subject.name} ({count})
                    </a>
                  );
                })}
              </div>
            </div>

            <!-- Top Expertise Areas -->
            {
              topSubjects.length > 0 && (
                <div class="rounded-lg border border-border bg-muted/30 p-6">
                  <h3 class="font-semibold mb-4">Most Common</h3>
                  <div class="space-y-2">
                    {topSubjects.map(([subject, count]) => (
                      <div class="flex items-center justify-between text-sm">
                        <span class="capitalize">{subject.replace('-', ' ')}</span>
                        <span class="text-muted-foreground">{count}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )
            }

            <!-- CTA for Lobbyists -->
            <div class="rounded-lg border border-texas-gold-500 bg-texas-gold-500/5 p-6">
              <h3 class="font-semibold mb-2">Are you a lobbyist?</h3>
              <p class="text-sm text-muted-foreground mb-4">
                Add {city.name} to your service areas and get discovered by local businesses.
              </p>
              <a
                href="/claim-profile"
                class="inline-flex items-center justify-center rounded-md bg-texas-gold-500 px-4 py-2 text-sm font-medium text-white hover:bg-texas-gold-600 transition-colors w-full"
              >
                Claim Your Profile
              </a>
            </div>
          </div>
        </div>

        <!-- Lobbyists List -->
        <div class="lg:col-span-3">
          {
            lobbyists && lobbyists.length > 0 ? (
              <div class="space-y-10">
                {/* Results Header */}
                <div class="flex items-center justify-between">
                  <h2 class="text-2xl font-bold">
                    {lobbyists.length} Lobbyist{lobbyists.length !== 1 ? 's' : ''} in {city.name}
                  </h2>
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-muted-foreground">Sort by:</span>
                    <select class="text-sm border border-border rounded-md px-3 py-1.5 bg-white">
                      <option>Most Relevant</option>
                      <option>Most Viewed</option>
                      <option>Newest First</option>
                    </select>
                  </div>
                </div>

                {/* Searchable Lobbyists List */}
                <SearchableList lobbyists={lobbyists} client:load />
              </div>
            ) : (
              /* Empty State */
              <div class="text-center py-16 rounded-lg border border-dashed border-border">
                <svg
                  class="mx-auto h-16 w-16 text-muted-foreground/50"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  />
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                  />
                </svg>
                <h3 class="mt-4 text-xl font-semibold">No lobbyists found</h3>
                <p class="mt-2 text-muted-foreground">
                  We don't have any registered lobbyists for {city.name} yet.
                </p>
                <div class="mt-6 flex gap-3 justify-center">
                  <a
                    href="/cities"
                    class="inline-flex items-center justify-center rounded-md border border-border px-4 py-2 text-sm font-medium hover:bg-accent transition-colors"
                  >
                    Browse All Cities
                  </a>
                  <a
                    href="/claim-profile"
                    class="inline-flex items-center justify-center rounded-md bg-texas-blue px-4 py-2 text-sm font-medium text-white hover:bg-texas-blue-500/90 transition-colors"
                  >
                    List Your Services
                  </a>
                </div>
              </div>
            )
          }

          {/* Why Hire a Local Lobbyist */}
          <div class="mt-12 rounded-lg border border-border bg-muted/30 p-8">
            <h2 class="text-2xl font-bold mb-4">Why Hire a {city.name} Lobbyist?</h2>
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <h3 class="font-semibold mb-2 flex items-center gap-2">
                  <svg
                    class="h-5 w-5 text-texas-blue-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"></path>
                  </svg>
                  Local Expertise
                </h3>
                <p class="text-sm text-muted-foreground">
                  Deep understanding of {city.name}'s political landscape and decision-makers.
                </p>
              </div>
              <div>
                <h3 class="font-semibold mb-2 flex items-center gap-2">
                  <svg
                    class="h-5 w-5 text-texas-blue-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"></path>
                  </svg>
                  Established Relationships
                </h3>
                <p class="text-sm text-muted-foreground">
                  Pre-existing connections with local officials and regional legislators.
                </p>
              </div>
              <div>
                <h3 class="font-semibold mb-2 flex items-center gap-2">
                  <svg
                    class="h-5 w-5 text-texas-blue-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"></path>
                  </svg>
                  Regional Focus
                </h3>
                <p class="text-sm text-muted-foreground">
                  Specialized knowledge of {city.county ? `${city.county} County` : 'regional'}{' '}
                  issues and opportunities.
                </p>
              </div>
              <div>
                <h3 class="font-semibold mb-2 flex items-center gap-2">
                  <svg
                    class="h-5 w-5 text-texas-blue-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"></path>
                  </svg>
                  Responsive Service
                </h3>
                <p class="text-sm text-muted-foreground">
                  Local lobbyists can meet in person and respond quickly to urgent needs.
                </p>
              </div>
            </div>
          </div>

          {/* CTA Section */}
          <div class="mt-12 rounded-lg bg-gradient-to-br from-texas-blue-500 to-texas-blue-600 text-white p-8">
            <div class="max-w-2xl">
              <h2 class="text-3xl font-bold mb-3">Need Political Representation in {city.name}?</h2>
              <p class="text-white/90 mb-6">
                Connect with experienced lobbyists who understand your industry and have the
                relationships to get results.
              </p>
              <div class="flex flex-col sm:flex-row gap-3">
                <a
                  href="/signup"
                  class="inline-flex items-center justify-center rounded-md bg-white px-6 py-3 text-base font-medium text-texas-blue-500 hover:bg-white/90 transition-colors"
                >
                  Get Started
                </a>
                <a
                  href="/lobbyists"
                  class="inline-flex items-center justify-center rounded-md border-2 border-white px-6 py-3 text-base font-medium text-white hover:bg-white/10 transition-colors"
                >
                  Browse All Lobbyists
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>
