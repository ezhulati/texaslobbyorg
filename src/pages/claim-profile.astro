---
import Layout from '@/components/astro/Layout.astro';
import ClaimProfileForm from '@/components/react/ClaimProfileForm';
import { supabase } from '@/lib/supabase';

// Check if user is authenticated (from middleware)
const user = Astro.locals.user;

// Check for auto-detection query params (from signup flow)
const autoDetect = Astro.url.searchParams.get('auto') === 'true';
const prefilledEmail = Astro.url.searchParams.get('email') || null;

// If user is authenticated, check if they already have a claimed profile
let alreadyClaimed = false;
if (user) {
  const { data } = await supabase
    .from('lobbyists')
    .select('id, slug')
    .eq('user_id', user.id)
    .eq('is_claimed', true)
    .single();

  if (data) {
    // User already has a claimed profile, redirect to it
    return Astro.redirect(`/lobbyists/${data.slug}`);
  }
}

// SEO-optimized title (55-60 chars) and description (155-160 chars)
const pageTitle = 'Claim Your Texas Lobbyist Profile | Free Listing';
const pageDescription = 'Claim your lobbyist profile on TexasLobby.org. Manage your information, showcase clients, increase visibility. Connect with Texas businesses seeking advocacy.';
---

<Layout title={pageTitle} description={pageDescription}>
  <!-- Claim Profile Page -->
  <section class="py-16 min-h-[calc(100vh-4rem)]">
    <div class="container max-w-4xl">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-3xl md:text-4xl font-bold mb-4">Claim Your Profile</h1>
        <p class="text-lg text-muted-foreground max-w-2xl mx-auto">
          If you're a registered lobbyist in Texas, you likely already have a profile in our directory. Claim it to take control of your information and showcase your expertise.
        </p>
      </div>

      <!-- Benefits Section -->
      <div class="grid md:grid-cols-3 gap-6 mb-12">
        <div class="rounded-lg border border-border bg-white p-6">
          <div class="mb-3">
            <svg
              class="h-10 w-10 text-texas-blue-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
          </div>
          <h3 class="font-semibold mb-2">Control Your Information</h3>
          <p class="text-sm text-muted-foreground">
            Update your bio, contact details, and areas of expertise
          </p>
        </div>

        <div class="rounded-lg border border-border bg-white p-6">
          <div class="mb-3">
            <svg
              class="h-10 w-10 text-texas-blue-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
              ></path>
            </svg>
          </div>
          <h3 class="font-semibold mb-2">Showcase Your Clients</h3>
          <p class="text-sm text-muted-foreground">
            Highlight your client relationships and track record
          </p>
        </div>

        <div class="rounded-lg border border-border bg-white p-6">
          <div class="mb-3">
            <svg
              class="h-10 w-10 text-texas-blue-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
              ></path>
            </svg>
          </div>
          <h3 class="font-semibold mb-2">Increase Visibility</h3>
          <p class="text-sm text-muted-foreground">
            Upgrade to Premium or Featured for priority placement
          </p>
        </div>
      </div>

      {!user ? (
        <!-- Not Logged In -->
        <div class="rounded-lg border-2 border-dashed border-texas-blue/30 bg-texas-blue-500/5 p-8 text-center">
          <h3 class="text-xl font-semibold mb-3">Sign In Required</h3>
          <p class="text-muted-foreground mb-6">
            You need to sign in or create an account before claiming your profile. This helps us verify your identity and protect your information.
          </p>
          <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <a
              href="/login"
              class="inline-flex items-center justify-center rounded-md bg-texas-blue-500 px-6 py-3 text-base font-medium text-white hover:bg-texas-blue-600 transition-colors"
            >
              Sign In
            </a>
            <a
              href="/signup"
              class="inline-flex items-center justify-center rounded-md border border-border px-6 py-3 text-base font-medium hover:bg-accent transition-colors"
            >
              Create Account
            </a>
          </div>
        </div>
      ) : (
        <!-- Logged In - Show Claim Form -->
        <div class="space-y-6">
          <!-- Auto-Detection Banner (if coming from signup) -->
          {autoDetect && prefilledEmail && (
            <div class="rounded-lg border-2 border-texas-blue-200 bg-texas-blue-50 p-6">
              <div class="flex gap-3">
                <svg class="h-6 w-6 text-texas-blue-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <div>
                  <h3 class="font-semibold text-texas-blue-900 mb-1">We Found Your Profile!</h3>
                  <p class="text-sm text-texas-blue-800">
                    Great news! We found an existing profile for <strong>{prefilledEmail}</strong>. Review the details below and claim it to manage your listing.
                  </p>
                </div>
              </div>
            </div>
          )}

          <div class="rounded-lg border border-border bg-white p-8">
            <ClaimProfileForm
              client:load
              userId={user.id}
              userEmail={user.email || undefined}
              autoDetect={autoDetect}
              prefilledEmail={prefilledEmail}
            />
          </div>
        </div>
      )}

      <!-- Create New Profile CTA -->
      <div class="mt-8 rounded-lg border-2 border-dashed border-texas-gold-500/50 bg-texas-gold-500/5 p-6">
        <h3 class="font-semibold mb-2 text-lg">Can't find your profile?</h3>
        <p class="text-sm text-muted-foreground mb-4">
          If you're a newly registered lobbyist or haven't appeared in Texas Ethics Commission data yet, you can create a new profile. It will be reviewed by our team before going live.
        </p>
        <a
          href="/create-profile"
          class="inline-flex items-center justify-center rounded-md bg-texas-gold-500 px-6 py-2.5 text-sm font-medium text-white hover:bg-texas-gold-600 transition-colors"
        >
          Create New Profile
        </a>
      </div>

      <!-- Additional Info -->
      <div class="mt-12 space-y-6">
        <div class="rounded-lg border border-border bg-muted/30 p-6">
          <h3 class="font-semibold mb-3">How does profile claiming work?</h3>
          <ol class="space-y-2 text-sm text-muted-foreground">
            <li class="flex gap-3">
              <span class="flex-shrink-0 font-semibold text-foreground">1.</span>
              <span>Sign in or create an account using your professional email address</span>
            </li>
            <li class="flex gap-3">
              <span class="flex-shrink-0 font-semibold text-foreground">2.</span>
              <span>Search for your profile using your email or name</span>
            </li>
            <li class="flex gap-3">
              <span class="flex-shrink-0 font-semibold text-foreground">3.</span>
              <span>Verify your identity (your email must match our records)</span>
            </li>
            <li class="flex gap-3">
              <span class="flex-shrink-0 font-semibold text-foreground">4.</span>
              <span>Start managing your profile and connecting with potential clients</span>
            </li>
          </ol>
        </div>

        <div class="rounded-lg border border-border bg-muted/30 p-6">
          <h3 class="font-semibold mb-3">Frequently Asked Questions</h3>
          <div class="space-y-4">
            <div>
              <h4 class="font-medium text-sm mb-1">What if I can't find my profile?</h4>
              <p class="text-sm text-muted-foreground">
                Our directory is based on Texas Ethics Commission registration data. If you're a registered lobbyist but can't find your profile, please contact us at{' '}
                <a href="mailto:support@texaslobby.org" class="text-texas-blue-500 hover:underline">
                  support@texaslobby.org
                </a>
              </p>
            </div>
            <div>
              <h4 class="font-medium text-sm mb-1">Is claiming my profile free?</h4>
              <p class="text-sm text-muted-foreground">
                Yes! Claiming your profile and maintaining a basic listing is completely free. You can upgrade to Premium ($297/mo) or Featured ($597/mo) for enhanced visibility and analytics.
              </p>
            </div>
            <div>
              <h4 class="font-medium text-sm mb-1">What if the email doesn't match?</h4>
              <p class="text-sm text-muted-foreground">
                For security reasons, the email on your account must match the email we have on file from the Texas Ethics Commission. If you need to update your email, please contact support.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>
