---
import Layout from '@/components/astro/Layout.astro';
import LobbyistDashboard from '@/components/react/LobbyistDashboard';
import { createServerAuthClient } from '@/lib/supabase';

// Require authentication using cookie-based session
const supabase = createServerAuthClient(Astro.cookies);
const { data: { user }, error } = await supabase.auth.getUser();

if (error || !user) {
  return Astro.redirect('/login');
}

// Fetch lobbyist profile
const { data: lobbyistProfile, error: profileError } = await supabase
  .from('lobbyists')
  .select('*')
  .eq('user_id', user.id)
  .single();

// If user doesn't have a lobbyist profile, redirect to claim profile
if (profileError || !lobbyistProfile) {
  return Astro.redirect('/claim-profile');
}

// Count clients for this lobbyist
const { count: clientCount } = await supabase
  .from('clients')
  .select('*', { count: 'exact', head: true })
  .eq('lobbyist_id', lobbyistProfile.id);

const pageTitle = `Dashboard - ${lobbyistProfile.first_name} ${lobbyistProfile.last_name}`;
const pageDescription = 'Manage your TexasLobby.org lobbyist profile and account.';
---

<Layout title={pageTitle} description={pageDescription}>
  <section class="py-12 min-h-[calc(100vh-4rem)] bg-gray-50">
    <div class="container max-w-7xl">
      <LobbyistDashboard
        profile={lobbyistProfile}
        clientCount={clientCount || 0}
        client:load
      />
    </div>
  </section>
</Layout>
