---
import Layout from '@/components/astro/Layout.astro';
import SearchableList from '@/components/react/SearchableList';
import { supabase } from '@/lib/supabase';
import { getIndustryBySlug, INDUSTRY_SLUGS } from '@/lib/industries-data';

export async function getStaticPaths() {
  return INDUSTRY_SLUGS.map((slug) => ({
    params: { industry: slug },
  }));
}

const { industry } = Astro.params;

// Get industry data
const industryData = getIndustryBySlug(industry);

if (!industryData) {
  return Astro.redirect('/404');
}

// Get all lobbyists with their clients
const { data: lobbyists } = await supabase
  .from('lobbyists')
  .select(`
    *,
    clients (
      id,
      name,
      description,
      is_current
    )
  `)
  .eq('is_active', true)
  .order('subscription_tier', { ascending: false })
  .order('view_count', { ascending: false })
  .limit(10000); // Override default 1000 limit

// Helper: Check if client name matches industry keywords
function hasIndustryClient(clients: any[], keywords: string[]): boolean {
  if (!clients || clients.length === 0) return false;
  return clients.some((client) =>
    keywords.some((keyword) => client.name.toLowerCase().includes(keyword.toLowerCase()))
  );
}

// Helper: Count industry-relevant clients
function countIndustryClients(clients: any[], keywords: string[]): number {
  if (!clients || clients.length === 0) return 0;
  return clients.filter((client) =>
    keywords.some((keyword) => client.name.toLowerCase().includes(keyword.toLowerCase()))
  ).length;
}

// Helper: Get matching subjects
function getMatchingSubjects(subjectAreas: string[], relatedSubjects: string[]): string[] {
  if (!subjectAreas) return [];
  return subjectAreas.filter((area) =>
    relatedSubjects.some(
      (subject) => area.toLowerCase().includes(subject.toLowerCase()) || subject.toLowerCase().includes(area.toLowerCase())
    )
  );
}

// Helper: Calculate relevance score
function calculateRelevance(lobbyist: any, industryData: any): number {
  let score = 0;

  // Industry clients (highest weight)
  const clientCount = countIndustryClients(lobbyist.clients, industryData.clientKeywords);
  score += clientCount * 10;

  // Matching subjects
  const matchingSubjects = getMatchingSubjects(lobbyist.subject_areas, industryData.relatedSubjects);
  score += matchingSubjects.length * 3;

  // Subscription tier bonus
  if (lobbyist.subscription_tier === 'featured') score += 2;
  if (lobbyist.subscription_tier === 'premium') score += 1;

  // View count (normalized)
  score += Math.min(lobbyist.view_count / 100, 2);

  return score;
}

// Separate lobbyists into two groups
const lobbyistsWithExperience: any[] = [];
const lobbyistsWithExpertise: any[] = [];

lobbyists?.forEach((lobbyist) => {
  const matchingSubjects = getMatchingSubjects(lobbyist.subject_areas, industryData.relatedSubjects);
  const hasClients = hasIndustryClient(lobbyist.clients, industryData.clientKeywords);
  const clientCount = countIndustryClients(lobbyist.clients, industryData.clientKeywords);
  const relevance = calculateRelevance(lobbyist, industryData);

  // Add computed properties
  const enrichedLobbyist = {
    ...lobbyist,
    matchingSubjects,
    industryClientCount: clientCount,
    relevanceScore: relevance,
  };

  if (hasClients) {
    lobbyistsWithExperience.push(enrichedLobbyist);
  } else if (matchingSubjects.length > 0) {
    lobbyistsWithExpertise.push(enrichedLobbyist);
  }
});

// Sort by relevance
lobbyistsWithExperience.sort((a, b) => b.relevanceScore - a.relevanceScore);
lobbyistsWithExpertise.sort((a, b) => b.relevanceScore - a.relevanceScore);

const allRelevantLobbyists = [...lobbyistsWithExperience, ...lobbyistsWithExpertise];

// Get all cities for filtering
const { data: cities } = await supabase.from('cities').select('slug, name').order('name').limit(10000); // Override default 1000 limit

// Get city distribution
const cityCounts: Record<string, number> = {};
allRelevantLobbyists.forEach((lobbyist) => {
  lobbyist.cities?.forEach((city: string) => {
    cityCounts[city] = (cityCounts[city] || 0) + 1;
  });
});

const topCities = Object.entries(cityCounts)
  .sort(([, a], [, b]) => b - a)
  .slice(0, 5);

const featuredCount = allRelevantLobbyists.filter((l) => l.subscription_tier === 'featured').length;
const premiumCount = allRelevantLobbyists.filter((l) => l.subscription_tier === 'premium').length;

const pageTitle = industryData.metaTitle;
const pageDescription = industryData.metaDescription;
---

<Layout title={pageTitle} description={pageDescription}>
  <!-- Industry Header -->
  <section class="bg-texas-blue-500 text-white py-16">
    <div class="container">
      <div class="max-w-4xl">
        <div class="flex items-center gap-3 mb-4">
          <a href="/industries" class="text-white/80 hover:text-white text-sm">All Industries</a>
          <svg class="h-4 w-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"
            ></path>
          </svg>
          <span class="text-sm">{industryData.name}</span>
        </div>
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          {industryData.name} Lobbying in Texas
        </h1>
        <p class="text-xl text-white/90 mb-6">{industryData.description}</p>

        {/* Industry Stats */}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <div class="text-2xl font-bold">{lobbyistsWithExperience.length}</div>
            <div class="text-sm text-white/80">Proven Experience</div>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <div class="text-2xl font-bold">{lobbyistsWithExpertise.length}</div>
            <div class="text-sm text-white/80">Subject Experts</div>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <div class="text-2xl font-bold">{featuredCount + premiumCount}</div>
            <div class="text-sm text-white/80">Premium</div>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <div class="text-2xl font-bold">{industryData.spendingStats.annualSpending}</div>
            <div class="text-sm text-white/80">Annual Spending</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-12">
    <div class="container">
      <div class="grid lg:grid-cols-4 gap-8">
        <!-- Sidebar -->
        <div class="lg:col-span-1">
          <div class="sticky top-24 space-y-6">
            <!-- Spending Statistics -->
            <div class="rounded-lg border border-border bg-white p-6">
              <h3 class="font-semibold mb-4">Industry Spending</h3>
              <div class="space-y-4">
                <div>
                  <div class="text-sm text-muted-foreground mb-1">Annual Lobbying</div>
                  <div class="text-lg font-bold text-texas-blue-500">
                    {industryData.spendingStats.annualSpending}
                  </div>
                </div>
                <div>
                  <div class="text-sm text-muted-foreground mb-1">Active Lobbyists</div>
                  <div class="text-lg font-bold">{industryData.spendingStats.numberOfLobbyists}</div>
                </div>
                <div>
                  <div class="text-sm text-muted-foreground mb-1">Organizations</div>
                  <div class="text-lg font-bold">
                    {industryData.spendingStats.activeOrganizations}
                  </div>
                </div>
              </div>
            </div>

            <!-- Top Cities */}
            {
              topCities.length > 0 && (
                <div class="rounded-lg border border-border bg-muted/30 p-6">
                  <h3 class="font-semibold mb-4">Most Active Cities</h3>
                  <div class="space-y-2">
                    {topCities.map(([city, count]) => (
                      <div class="flex items-center justify-between text-sm">
                        <span class="capitalize">{city.replace('-', ' ')}</span>
                        <span class="text-muted-foreground">{count}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )
            }

            <!-- CTA for Businesses -->
            <div class="rounded-lg border border-texas-gold-500 bg-texas-gold-500/5 p-6">
              <h3 class="font-semibold mb-2">Need Industry Expertise?</h3>
              <p class="text-sm text-muted-foreground mb-4">
                Connect with lobbyists who understand {industryData.name.toLowerCase()} policy and
                have proven results in your sector.
              </p>
              <a
                href="/signup"
                class="inline-flex items-center justify-center rounded-md bg-texas-gold-500 px-4 py-2 text-sm font-medium text-white hover:bg-texas-gold-500/90 transition-colors w-full"
              >
                Get Started
              </a>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="lg:col-span-3">
          <!-- Industry Overview -->
          <div class="mb-12">
            <h2 class="text-3xl font-bold mb-6">Industry Overview</h2>
            <div class="prose prose-lg max-w-none text-muted-foreground">
              {
                industryData.overview.split('\n\n').map((paragraph) => (
                  <p class="mb-4">{paragraph}</p>
                ))
              }
            </div>
          </div>

          <!-- Top Spenders -->
          <div class="mb-12 rounded-lg border border-border bg-muted/30 p-8">
            <h2 class="text-2xl font-bold mb-4">Top Spenders in This Industry</h2>
            <ul class="space-y-3">
              {
                industryData.spendingStats.topSpenders.map((spender) => (
                  <li class="flex items-start gap-3">
                    <svg
                      class="h-6 w-6 text-texas-blue-500 mt-0.5 flex-shrink-0"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    <span class="text-lg">{spender}</span>
                  </li>
                ))
              }
            </ul>
          </div>

          <!-- Key Legislative Issues -->
          <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6">Key Legislative Issues</h2>
            <div class="grid md:grid-cols-2 gap-4">
              {
                industryData.keyIssues.map((issue) => (
                  <div class="flex items-start gap-3 p-4 rounded-lg border border-border bg-white">
                    <svg
                      class="h-5 w-5 text-texas-blue-500 mt-0.5 flex-shrink-0"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                      />
                    </svg>
                    <span class="text-sm">{issue}</span>
                  </div>
                ))
              }
            </div>
          </div>

          <!-- Lobbyists with Proven Experience -->
          {
            lobbyistsWithExperience.length > 0 && (
              <div class="mb-12">
                <div class="flex items-start justify-between mb-6">
                  <div>
                    <h2 class="text-2xl font-bold mb-2">
                      Lobbyists with Proven {industryData.name} Experience
                    </h2>
                    <p class="text-muted-foreground">
                      {lobbyistsWithExperience.length} {lobbyistsWithExperience.length === 1 ? 'lobbyist has' : 'lobbyists have'} represented clients in this industry
                    </p>
                  </div>
                  <div class="bg-texas-gold-500/10 border border-texas-gold-500 rounded-lg px-4 py-2">
                    <div class="text-xs font-semibold text-texas-gold-700 uppercase tracking-wide">
                      Best Match
                    </div>
                  </div>
                </div>

                <div class="mb-6 p-4 rounded-lg bg-blue-50 border border-blue-200">
                  <div class="flex gap-2">
                    <svg
                      class="h-5 w-5 text-blue-600 mt-0.5 flex-shrink-0"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                        clip-rule="evenodd"
                      />
                    </svg>
                    <p class="text-sm text-blue-900">
                      <strong>Why these lobbyists?</strong> Each has represented actual{' '}
                      {industryData.name.toLowerCase()} clients. Client counts and matching
                      expertise areas are shown on their profiles.
                    </p>
                  </div>
                </div>

                <SearchableList lobbyists={lobbyistsWithExperience} showIndustryBadges={true} client:load />
              </div>
            )
          }

          <!-- Subject Matter Experts -->
          {
            lobbyistsWithExpertise.length > 0 && (
              <div class="mb-12">
                <div class="mb-6">
                  <h2 class="text-2xl font-bold mb-2">
                    {industryData.name} Subject Matter Specialists
                  </h2>
                  <p class="text-muted-foreground">
                    {lobbyistsWithExpertise.length} additional {lobbyistsWithExpertise.length === 1 ? 'lobbyist' : 'lobbyists'} with relevant expertise in {industryData.relatedSubjects.join(', ')}
                  </p>
                </div>

                <div class="mb-6 p-4 rounded-lg bg-muted/30 border border-border">
                  <p class="text-sm text-muted-foreground">
                    These lobbyists have expertise in policy areas related to {industryData.name.toLowerCase()},
                    but haven't publicly listed clients in this specific industry. They may still be excellent
                    matches for your needs.
                  </p>
                </div>

                <SearchableList lobbyists={lobbyistsWithExpertise} showIndustryBadges={true} client:load />
              </div>
            )
          }

          <!-- Empty State -->
          {
            allRelevantLobbyists.length === 0 && (
              <div class="mb-12 text-center py-16 rounded-lg border border-dashed border-border">
                <svg
                  class="mx-auto h-16 w-16 text-muted-foreground/50"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                  />
                </svg>
                <h3 class="mt-4 text-xl font-semibold">Lobbyists Coming Soon</h3>
                <p class="mt-2 text-muted-foreground max-w-md mx-auto">
                  We're actively recruiting lobbyists with {industryData.name.toLowerCase()}{' '}
                  expertise. Check back soon or contact us to recommend professionals in this sector.
                </p>
              </div>
            )
          }

          {/* Why Hire Industry Experts */}
          <div class="mb-12 rounded-lg border border-border bg-muted/30 p-8">
            <h2 class="text-2xl font-bold mb-4">
              Why Hire a {industryData.name} Lobbyist?
            </h2>
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <h3 class="font-semibold mb-2 flex items-center gap-2">
                  <svg
                    class="h-5 w-5 text-texas-blue-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"></path>
                  </svg>
                  Industry-Specific Knowledge
                </h3>
                <p class="text-sm text-muted-foreground">
                  Deep understanding of {industryData.name.toLowerCase()} policy landscapes,
                  regulatory frameworks, and legislative priorities affecting your business.
                </p>
              </div>
              <div>
                <h3 class="font-semibold mb-2 flex items-center gap-2">
                  <svg
                    class="h-5 w-5 text-texas-blue-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"></path>
                  </svg>
                  Established Relationships
                </h3>
                <p class="text-sm text-muted-foreground">
                  Connections with key legislators, committee chairs, and agency officials who
                  oversee {industryData.name.toLowerCase()} regulations.
                </p>
              </div>
              <div>
                <h3 class="font-semibold mb-2 flex items-center gap-2">
                  <svg
                    class="h-5 w-5 text-texas-blue-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"></path>
                  </svg>
                  Proven Track Record
                </h3>
                <p class="text-sm text-muted-foreground">
                  Experience delivering results for {industryData.name.toLowerCase()} clients with
                  similar challenges and objectives.
                </p>
              </div>
              <div>
                <h3 class="font-semibold mb-2 flex items-center gap-2">
                  <svg
                    class="h-5 w-5 text-texas-blue-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"></path>
                  </svg>
                  Strategic Coalition Building
                </h3>
                <p class="text-sm text-muted-foreground">
                  Ability to build coalitions within the {industryData.name.toLowerCase()} sector
                  and across allied industries to amplify advocacy efforts.
                </p>
              </div>
            </div>
          </div>

          {/* CTA Section */}
          <div class="rounded-lg bg-gradient-to-br from-texas-blue to-texas-blue/80 text-white p-8">
            <div class="max-w-2xl">
              <h2 class="text-3xl font-bold mb-3">
                Ready to Engage on {industryData.name} Policy?
              </h2>
              <p class="text-white/90 mb-6">
                Connect with experienced {industryData.name.toLowerCase()} lobbyists who understand
                your industry's unique challenges and have the relationships to achieve results in
                Austin.
              </p>
              <div class="flex flex-col sm:flex-row gap-3">
                <a
                  href="/signup"
                  class="inline-flex items-center justify-center rounded-md bg-white px-6 py-3 text-base font-medium text-texas-blue-500 hover:bg-white/90 transition-colors"
                >
                  Find Your Lobbyist
                </a>
                <a
                  href="/lobbyists"
                  class="inline-flex items-center justify-center rounded-md border-2 border-white px-6 py-3 text-base font-medium text-white hover:bg-white/10 transition-colors"
                >
                  Browse All Lobbyists
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>
