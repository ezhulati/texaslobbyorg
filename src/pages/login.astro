---
import Layout from '@/components/astro/Layout.astro';
import AuthForm from '@/components/react/AuthForm';
import { supabase } from '@/lib/supabase';

// Get redirect parameter from URL
const redirectParam = Astro.url.searchParams.get('redirect');

// Redirect if already logged in (use middleware auth)
const user = Astro.locals.user;
if (user) {
  // If there's a redirect parameter, use it
  if (redirectParam) {
    return Astro.redirect(redirectParam);
  }

  // Otherwise, smart redirect based on user role and status
  if (user.role === 'admin') {
    return Astro.redirect('/admin');
  } else if (user.role === 'lobbyist') {
    // Check if lobbyist has a profile
    const { data: lobbyistProfile } = await supabase
      .from('lobbyists')
      .select('id')
      .eq('user_id', user.id)
      .single();

    if (lobbyistProfile) {
      return Astro.redirect('/dashboard');
    } else {
      return Astro.redirect('/claim-profile');
    }
  } else {
    // Searcher - check if they have favorites
    const { data: favorites } = await supabase
      .from('favorites')
      .select('id')
      .eq('user_id', user.id)
      .limit(1);

    if (favorites && favorites.length > 0) {
      return Astro.redirect('/favorites');
    } else {
      return Astro.redirect('/lobbyists');
    }
  }
}

// SEO-optimized title (55-60 chars) and description (155-160 chars)
const pageTitle = 'Log In | Access Your Texas Lobbyist Profile';
const pageDescription = 'Sign in to your TexasLobby.org account. Manage your lobbyist profile, update client information, track views, and connect with Texas businesses seeking advocacy.';
---

<Layout title={pageTitle} description={pageDescription}>
  <!-- Login Page -->
  <section class="py-16 min-h-[calc(100vh-4rem)]">
    <div class="max-w-md mx-auto px-4">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold mb-3">Welcome Back</h1>
        <p class="text-lg text-muted-foreground">
          Sign in to access your lobbyist profile and dashboard
        </p>
      </div>

      <!-- Login Form -->
      <div class="rounded-lg border border-border bg-white p-8 shadow-sm">
        <AuthForm client:load mode="login" redirectTo={redirectParam || "/dashboard"} />
      </div>

      <!-- Additional Info -->
      <div class="mt-8 text-center">
        <p class="text-sm text-muted-foreground mb-4">
          Looking for a lobbyist?{' '}
          <a href="/lobbyists" class="text-texas-blue-500 hover:underline">
            Browse our directory
          </a>
        </p>
        <p class="text-sm text-muted-foreground">
          Are you a lobbyist but don't have an account?{' '}
          <a href="/claim-profile" class="text-texas-blue-500 hover:underline">
            Claim your profile
          </a>
        </p>
      </div>
    </div>
  </section>
</Layout>
