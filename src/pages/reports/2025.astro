---
import Layout from '@/components/astro/Layout.astro';
import { supabase } from '@/lib/supabase';
import { getAllIndustries } from '@/lib/industries-data';

// Fetch all active lobbyists
const { data: lobbyists } = await supabase
  .from('lobbyists')
  .select('*')
  .eq('is_active', true);

// Fetch all clients (each row represents one lobbyist-client relationship)
const { data: allClients } = await supabase
  .from('clients')
  .select('*');

// Group clients by lobbyist
const lobbyistsWithClients = lobbyists?.map(lobbyist => ({
  ...lobbyist,
  lobbyist_clients: allClients
    ?.filter(client => client.lobbyist_id === lobbyist.id)
    .map(client => ({ client })) || []
})) || [];

// Calculate key statistics
const totalLobbyists = lobbyists?.length || 0;

// City breakdown
const cityData = lobbyists?.reduce((acc, l) => {
  l.cities?.forEach((city: string) => {
    acc[city] = (acc[city] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>) || {};

const topCities = Object.entries(cityData)
  .sort(([, a], [, b]) => b - a)
  .slice(0, 10);

// Subject area breakdown
const subjectData = lobbyists?.reduce((acc, l) => {
  l.subject_areas?.forEach((subject: string) => {
    acc[subject] = (acc[subject] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>) || {};

const topSubjects = Object.entries(subjectData)
  .sort(([, a], [, b]) => b - a)
  .slice(0, 15);

// Industry breakdown using our industry matching logic
const industries = getAllIndustries();
const industryData: Record<string, number> = {};

lobbyistsWithClients.forEach(lobbyist => {
  const lobbyistClients = lobbyist.lobbyist_clients?.map((lc: any) => lc.client) || [];

  industries.forEach(industry => {
    const hasMatch = lobbyistClients.some((client: any) =>
      industry.clientKeywords.some(keyword =>
        client?.name?.toLowerCase().includes(keyword.toLowerCase())
      )
    );

    if (hasMatch) {
      industryData[industry.name] = (industryData[industry.name] || 0) + 1;
    }
  });
});

const topIndustries = Object.entries(industryData)
  .sort(([, a], [, b]) => b - a);

// Total clients
const totalClients = allClients?.length || 0;

// Calculate percentage with multiple specialties
const multiSpecialtyCount = lobbyists?.filter(l => (l.subject_areas?.length || 0) > 1).length || 0;
const multiSpecialtyPct = ((multiSpecialtyCount / totalLobbyists) * 100).toFixed(1);

// Client categorization - count lobbyists per client
const clientLobbyistCounts: Record<string, { name: string; count: number }> = {};

allClients?.forEach(client => {
  const clientName = client.name;
  if (clientName) {
    if (!clientLobbyistCounts[clientName]) {
      clientLobbyistCounts[clientName] = { name: clientName, count: 0 };
    }
    clientLobbyistCounts[clientName].count++;
  }
});

// Define category keywords
const categoryKeywords = {
  lobbyTeams: ['hillco', 'partners', 'lobby group', 'alliance', 'blackridge', 'schlueter'],
  lawFirms: ['troutman', 'greenberg', 'scarborough', 'boone', 'kelly hart', 'law', 'attorneys', 'legal'],
  corporate: ['charter', 'at&t', 'att', "landry's", 'h-e-b', 'heb', 'oncor', 'corp', 'inc.', 'llc', 'company'],
  privateAssociations: ['medical association', 'lawsuit reform', 'realtors', 'hospital association', 'oil & gas', 'oil and gas', 'trade association'],
  publicAssociations: ['school boards', 'school administrators', 'municipal league', 'association of counties', 'classroom teachers', 'public'],
  causesIssues: ['tppf', 'ttara', 'strive', 'raise your hand', 'moak casey', 'foundation', 'institute', 'coalition']
};

// Helper to categorize client
const categorizeClient = (name: string): string | null => {
  const lowerName = name.toLowerCase();

  // Check in priority order
  if (categoryKeywords.lobbyTeams.some(k => lowerName.includes(k))) return 'lobbyTeams';
  if (categoryKeywords.lawFirms.some(k => lowerName.includes(k))) return 'lawFirms';
  if (categoryKeywords.privateAssociations.some(k => lowerName.includes(k))) return 'privateAssociations';
  if (categoryKeywords.publicAssociations.some(k => lowerName.includes(k))) return 'publicAssociations';
  if (categoryKeywords.causesIssues.some(k => lowerName.includes(k))) return 'causesIssues';
  if (categoryKeywords.corporate.some(k => lowerName.includes(k))) return 'corporate';

  return null;
};

// Sort clients by lobbyist count
const sortedClients = Object.values(clientLobbyistCounts).sort((a, b) => b.count - a.count);

// Categorize and get top 5 for each
const categorizedClients: Record<string, Array<{ name: string; count: number }>> = {
  lobbyTeams: [],
  lawFirms: [],
  corporate: [],
  privateAssociations: [],
  publicAssociations: [],
  causesIssues: []
};

sortedClients.forEach(client => {
  const category = categorizeClient(client.name);
  if (category && categorizedClients[category].length < 5) {
    categorizedClients[category].push(client);
  }
});

// SEO
const pageTitle = 'The State of Texas Lobbying: 2025 Annual Report | TexasLobby.org';
const pageDescription = `Comprehensive data analysis of Texas lobbying in 2025. ${totalLobbyists.toLocaleString()} active lobbyists, ${totalClients.toLocaleString()} clients, and insights into the state's most influential industries and policy areas.`;

const schema = {
  '@context': 'https://schema.org',
  '@type': 'Report',
  name: 'The State of Texas Lobbying: 2025 Annual Report',
  url: 'https://texaslobby.org/reports/2025',
  description: pageDescription,
  datePublished: '2025-01-06',
  publisher: {
    '@type': 'Organization',
    name: 'TexasLobby.org',
    url: 'https://texaslobby.org'
  }
};
---

<Layout title={pageTitle} description={pageDescription} schema={schema}>
  <!-- Hero Section -->
  <section class="bg-gradient-to-b from-texas-blue-500/10 to-background py-16 border-b border-border">
    <div class="container">
      <div class="max-w-4xl mx-auto text-center">
        <div class="inline-flex items-center rounded-full bg-texas-blue-500/10 px-4 py-2 text-sm font-medium text-texas-blue-700 mb-6">
          Annual Report • 2025
        </div>
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-6">
          The State of Texas Lobbying: 2025
        </h1>
        <p class="text-xl text-muted-foreground mb-8">
          A comprehensive data-driven analysis of lobbying activity, influence, and trends across the Lone Star State
        </p>
        <div class="flex flex-wrap gap-4 justify-center text-sm text-muted-foreground">
          <div class="flex items-center gap-2">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Published January 2025
          </div>
          <div class="flex items-center gap-2">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            Based on {totalLobbyists.toLocaleString()} active lobbyists
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Key Findings / Executive Summary -->
  <section class="py-16 bg-muted/30">
    <div class="container">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold mb-8 text-center">Key Findings</h2>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-white rounded-lg border border-border p-6">
            <div class="text-4xl font-bold text-texas-blue-500 mb-2">{totalLobbyists.toLocaleString()}</div>
            <div class="text-sm font-medium text-muted-foreground uppercase tracking-wide mb-2">Active Lobbyists</div>
            <p class="text-sm text-muted-foreground">Registered and actively representing clients in Texas</p>
          </div>

          <div class="bg-white rounded-lg border border-border p-6">
            <div class="text-4xl font-bold text-texas-blue-500 mb-2">{totalClients.toLocaleString()}</div>
            <div class="text-sm font-medium text-muted-foreground uppercase tracking-wide mb-2">Total Clients</div>
            <p class="text-sm text-muted-foreground">Organizations represented by Texas lobbyists</p>
          </div>

          <div class="bg-white rounded-lg border border-border p-6 md:col-span-2">
            <div class="text-4xl font-bold text-texas-blue-500 mb-2">{multiSpecialtyPct}%</div>
            <div class="text-sm font-medium text-muted-foreground uppercase tracking-wide mb-2">Multi-Specialty Lobbyists</div>
            <p class="text-sm text-muted-foreground">Work across multiple policy areas</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Geographic Distribution -->
  <section class="py-16">
    <div class="container">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold mb-4">Geographic Distribution</h2>
        <p class="text-muted-foreground mb-8">Where Texas lobbyists are based and operate</p>

        <div class="bg-white rounded-lg border border-border overflow-hidden">
          <div class="p-6 border-b border-border bg-muted/30">
            <h3 class="font-semibold">Top 10 Cities by Lobbyist Concentration</h3>
          </div>
          <div class="p-6">
            <div class="space-y-4">
              {topCities.map(([city, count], index) => {
                const percentage = ((count / totalLobbyists) * 100).toFixed(1);
                const barWidth = Math.max(10, (count / topCities[0][1]) * 100);

                return (
                  <div key={city}>
                    <div class="flex items-center justify-between mb-2">
                      <div class="flex items-center gap-3">
                        <span class="text-sm font-mono text-muted-foreground w-6">#{index + 1}</span>
                        <a href={`/cities/${city.toLowerCase().replace(/\s+/g, '-')}`} class="font-medium hover:text-texas-blue-500">
                          {city}
                        </a>
                      </div>
                      <div class="text-sm text-muted-foreground">
                        <span class="font-semibold text-foreground">{count}</span> ({percentage}%)
                      </div>
                    </div>
                    <div class="w-full bg-muted rounded-full h-2">
                      <div
                        class="bg-texas-blue-500 h-2 rounded-full transition-all"
                        style={`width: ${barWidth}%`}
                      />
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
          <h3 class="font-semibold text-blue-900 mb-2">Key Insight</h3>
          <p class="text-sm text-blue-800">
            Austin dominates Texas lobbying with {cityData['Austin']?.toLocaleString() || '0'} active lobbyists ({((cityData['Austin'] / totalLobbyists) * 100).toFixed(1)}% of all lobbyists),
            reflecting its role as the state capital. However, major metros like Houston, Dallas, and San Antonio
            maintain significant lobbying presences to represent local business and civic interests.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Policy Areas & Industries -->
  <section class="py-16 bg-muted/30">
    <div class="container">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold mb-4">Most Lobbied Policy Areas</h2>
        <p class="text-muted-foreground mb-8">The subjects drawing the most lobbying attention in Texas</p>

        <div class="bg-white rounded-lg border border-border overflow-hidden mb-12">
          <div class="p-6 border-b border-border bg-muted/30">
            <h3 class="font-semibold">Top 15 Subject Areas by Lobbyist Count</h3>
          </div>
          <div class="p-6">
            <div class="grid md:grid-cols-2 gap-x-8 gap-y-4">
              {topSubjects.map(([subject, count], index) => {
                const percentage = ((count / totalLobbyists) * 100).toFixed(1);

                return (
                  <div key={subject} class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <span class="text-sm font-mono text-muted-foreground w-6">#{index + 1}</span>
                      <a
                        href={`/subjects/${subject.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/, '')}`}
                        class="font-medium hover:text-texas-blue-500"
                      >
                        {subject}
                      </a>
                    </div>
                    <div class="text-sm text-muted-foreground">
                      <span class="font-semibold text-foreground">{count}</span>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        </div>

        <!-- Industries -->
        <h2 class="text-3xl font-bold mb-4">Industry Representation</h2>
        <p class="text-muted-foreground mb-8">Major industries with active lobbying efforts</p>

        <div class="grid md:grid-cols-2 gap-6">
          {topIndustries.map(([industry, count]) => {
            const industrySlug = industry.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            const percentage = ((count / totalLobbyists) * 100).toFixed(1);

            return (
              <a
                href={`/industries/${industrySlug}`}
                key={industry}
                class="bg-white rounded-lg border border-border p-6 hover:border-texas-blue-500 transition-colors"
              >
                <h3 class="font-semibold text-lg mb-2">{industry}</h3>
                <div class="text-3xl font-bold text-texas-blue-500 mb-1">{count}</div>
                <div class="text-sm text-muted-foreground">
                  {percentage}% of lobbyists represent clients in this industry
                </div>
              </a>
            );
          })}
        </div>
      </div>
    </div>
  </section>

  <!-- Most Lobbied Organizations -->
  <section class="py-16">
    <div class="container">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold mb-4">Most Lobbied Organizations</h2>
        <p class="text-muted-foreground mb-8">Top clients by number of lobbyists representing them</p>

        <div class="grid md:grid-cols-2 gap-8">
          <!-- Lobby Teams -->
          {categorizedClients.lobbyTeams.length > 0 && (
            <div class="bg-white rounded-lg border border-border overflow-hidden">
              <div class="p-4 bg-gradient-to-r from-red-50 to-red-100 border-b border-red-200">
                <h3 class="font-bold text-red-900 uppercase tracking-wide text-sm">Lobby Teams</h3>
              </div>
              <div class="p-6">
                <ol class="space-y-3">
                  {categorizedClients.lobbyTeams.map((client, index) => (
                    <li key={client.name} class="flex items-start justify-between">
                      <div class="flex items-start gap-3">
                        <span class="text-sm font-semibold text-muted-foreground min-w-[1.5rem]">{index + 1}</span>
                        <span class="text-texas-blue-500 font-medium hover:underline">{client.name}</span>
                      </div>
                      <span class="text-sm text-muted-foreground">{client.count}</span>
                    </li>
                  ))}
                </ol>
              </div>
            </div>
          )}

          <!-- Law Firms -->
          {categorizedClients.lawFirms.length > 0 && (
            <div class="bg-white rounded-lg border border-border overflow-hidden">
              <div class="p-4 bg-gradient-to-r from-red-50 to-red-100 border-b border-red-200">
                <h3 class="font-bold text-red-900 uppercase tracking-wide text-sm">Law Firms</h3>
              </div>
              <div class="p-6">
                <ol class="space-y-3">
                  {categorizedClients.lawFirms.map((client, index) => (
                    <li key={client.name} class="flex items-start justify-between">
                      <div class="flex items-start gap-3">
                        <span class="text-sm font-semibold text-muted-foreground min-w-[1.5rem]">{index + 1}</span>
                        <span class="text-texas-blue-500 font-medium hover:underline">{client.name}</span>
                      </div>
                      <span class="text-sm text-muted-foreground">{client.count}</span>
                    </li>
                  ))}
                </ol>
              </div>
            </div>
          )}

          <!-- Corporate -->
          {categorizedClients.corporate.length > 0 && (
            <div class="bg-white rounded-lg border border-border overflow-hidden">
              <div class="p-4 bg-gradient-to-r from-red-50 to-red-100 border-b border-red-200">
                <h3 class="font-bold text-red-900 uppercase tracking-wide text-sm">Corporate</h3>
              </div>
              <div class="p-6">
                <ol class="space-y-3">
                  {categorizedClients.corporate.map((client, index) => (
                    <li key={client.name} class="flex items-start justify-between">
                      <div class="flex items-start gap-3">
                        <span class="text-sm font-semibold text-muted-foreground min-w-[1.5rem]">{index + 1}</span>
                        <span class="text-texas-blue-500 font-medium hover:underline">{client.name}</span>
                      </div>
                      <span class="text-sm text-muted-foreground">{client.count}</span>
                    </li>
                  ))}
                </ol>
              </div>
            </div>
          )}

          <!-- Private Associations -->
          {categorizedClients.privateAssociations.length > 0 && (
            <div class="bg-white rounded-lg border border-border overflow-hidden">
              <div class="p-4 bg-gradient-to-r from-red-50 to-red-100 border-b border-red-200">
                <h3 class="font-bold text-red-900 uppercase tracking-wide text-sm">Private Associations</h3>
              </div>
              <div class="p-6">
                <ol class="space-y-3">
                  {categorizedClients.privateAssociations.map((client, index) => (
                    <li key={client.name} class="flex items-start justify-between">
                      <div class="flex items-start gap-3">
                        <span class="text-sm font-semibold text-muted-foreground min-w-[1.5rem]">{index + 1}</span>
                        <span class="text-texas-blue-500 font-medium hover:underline">{client.name}</span>
                      </div>
                      <span class="text-sm text-muted-foreground">{client.count}</span>
                    </li>
                  ))}
                </ol>
              </div>
            </div>
          )}

          <!-- Public Associations -->
          {categorizedClients.publicAssociations.length > 0 && (
            <div class="bg-white rounded-lg border border-border overflow-hidden">
              <div class="p-4 bg-gradient-to-r from-red-50 to-red-100 border-b border-red-200">
                <h3 class="font-bold text-red-900 uppercase tracking-wide text-sm">Public Associations</h3>
              </div>
              <div class="p-6">
                <ol class="space-y-3">
                  {categorizedClients.publicAssociations.map((client, index) => (
                    <li key={client.name} class="flex items-start justify-between">
                      <div class="flex items-start gap-3">
                        <span class="text-sm font-semibold text-muted-foreground min-w-[1.5rem]">{index + 1}</span>
                        <span class="text-texas-blue-500 font-medium hover:underline">{client.name}</span>
                      </div>
                      <span class="text-sm text-muted-foreground">{client.count}</span>
                    </li>
                  ))}
                </ol>
              </div>
            </div>
          )}

          <!-- Causes & Issues -->
          {categorizedClients.causesIssues.length > 0 && (
            <div class="bg-white rounded-lg border border-border overflow-hidden">
              <div class="p-4 bg-gradient-to-r from-red-50 to-red-100 border-b border-red-200">
                <h3 class="font-bold text-red-900 uppercase tracking-wide text-sm">Causes & Issues</h3>
              </div>
              <div class="p-6">
                <ol class="space-y-3">
                  {categorizedClients.causesIssues.map((client, index) => (
                    <li key={client.name} class="flex items-start justify-between">
                      <div class="flex items-start gap-3">
                        <span class="text-sm font-semibold text-muted-foreground min-w-[1.5rem]">{index + 1}</span>
                        <span class="text-texas-blue-500 font-medium hover:underline">{client.name}</span>
                      </div>
                      <span class="text-sm text-muted-foreground">{client.count}</span>
                    </li>
                  ))}
                </ol>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Methodology -->
  <section class="py-16 bg-muted/30">
    <div class="container">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold mb-4">Methodology & Data Sources</h2>
        <div class="prose prose-lg max-w-none">
          <p class="text-muted-foreground">
            This report is based on comprehensive data from the Texas Ethics Commission's public lobbying disclosure records,
            supplemented by lobbyist-submitted profile information on TexasLobby.org. All statistics reflect active registered
            lobbyists and their publicly disclosed client relationships as of January 2025.
          </p>

          <div class="mt-6 bg-white rounded-lg border border-border p-6">
            <h3 class="text-lg font-semibold mb-3">Data Collection</h3>
            <ul class="space-y-2 text-sm text-muted-foreground">
              <li>• Lobbyist registration data from Texas Ethics Commission</li>
              <li>• Client representation disclosures filed with TEC</li>
              <li>• Subject matter expertise self-reported by lobbyists</li>
              <li>• Geographic service areas based on lobbyist-provided information</li>
              <li>• Industry classification using automated keyword matching against client names</li>
            </ul>
          </div>

          <div class="mt-6 bg-white rounded-lg border border-border p-6">
            <h3 class="text-lg font-semibold mb-3">Limitations</h3>
            <ul class="space-y-2 text-sm text-muted-foreground">
              <li>• Some lobbyists may work across multiple offices; counts reflect primary location</li>
              <li>• Subject areas are self-reported and may not capture all expertise</li>
              <li>• Industry matching is automated and may not be 100% accurate for all clients</li>
              <li>• Unclaimed profiles contain only publicly available TEC data</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Share & Citation -->
  <section class="py-16 border-t border-border">
    <div class="container">
      <div class="max-w-4xl mx-auto text-center">
        <h2 class="text-2xl font-bold mb-4">Share This Report</h2>
        <p class="text-muted-foreground mb-8">
          Help promote transparency in Texas lobbying by sharing these insights
        </p>

        <div class="bg-muted rounded-lg p-6 mb-8">
          <div class="text-xs uppercase tracking-wide text-muted-foreground mb-2">Cite this report as:</div>
          <div class="font-mono text-sm bg-white rounded border border-border p-4">
            TexasLobby.org (2025). The State of Texas Lobbying: 2025 Annual Report.
            Retrieved from https://texaslobby.org/reports/2025
          </div>
        </div>

        <div class="flex gap-4 justify-center">
          <a
            href="/lobbyists"
            class="inline-flex items-center justify-center rounded-md bg-texas-blue-500 px-6 py-3 text-base font-medium text-white hover:bg-texas-blue-500/90 transition-colors"
          >
            Explore All Lobbyists
          </a>
          <a
            href="/industries"
            class="inline-flex items-center justify-center rounded-md border-2 border-texas-blue-500 text-texas-blue-500 px-6 py-3 text-base font-medium hover:bg-texas-blue-500/5 transition-colors"
          >
            Browse by Industry
          </a>
        </div>
      </div>
    </div>
  </section>
</Layout>
