---
import Layout from '@/components/astro/Layout.astro';
import LobbyistCard from '@/components/react/LobbyistCard';
import { supabase } from '@/lib/supabase';

const { slug } = Astro.params;

// Get subject area data
const { data: subject, error: subjectError } = await supabase
  .from('subject_areas')
  .select('*')
  .eq('slug', slug)
  .single();

if (subjectError || !subject) {
  return Astro.redirect('/404');
}

// Get lobbyists with this expertise
const { data: lobbyists } = await supabase
  .from('lobbyists')
  .select('*')
  .contains('subject_areas', [subject.name])
  .eq('is_active', true)
  .order('subscription_tier', { ascending: false })
  .order('view_count', { ascending: false });

// Get all cities for filtering
const { data: cities } = await supabase.from('cities').select('slug, name').order('name');

// Get city distribution for this subject area
const cityCounts: Record<string, number> = {};
lobbyists?.forEach((lobbyist) => {
  lobbyist.cities?.forEach((city: string) => {
    cityCounts[city] = (cityCounts[city] || 0) + 1;
  });
});

const topCities = Object.entries(cityCounts)
  .sort(([, a], [, b]) => b - a)
  .slice(0, 5);

const featuredCount = lobbyists?.filter((l) => l.subscription_tier === 'featured').length || 0;
const premiumCount = lobbyists?.filter((l) => l.subscription_tier === 'premium').length || 0;
const totalYearsExperience = lobbyists?.reduce((sum, l) => {
  // Rough estimate based on sample data
  return sum + 10;
}, 0) || 0;
const avgYearsExperience = lobbyists?.length ? Math.round(totalYearsExperience / lobbyists.length) : 0;

const pageTitle = subject.meta_title || `${subject.name} Lobbyists in Texas | TexasLobby.org`;
const pageDescription =
  subject.meta_description ||
  `Find experienced ${subject.name.toLowerCase()} lobbyists in Texas. ${subject.description}`;
---

<Layout title={pageTitle} description={pageDescription}>
  <!-- Subject Header -->
  <section class="bg-texas-blue text-white py-16">
    <div class="container">
      <div class="max-w-4xl">
        <div class="flex items-center gap-3 mb-4">
          <a href="/subjects" class="text-white/80 hover:text-white text-sm">All Expertise Areas</a>
          <svg class="h-4 w-4 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"
            ></path>
          </svg>
          <span class="text-sm">{subject.name}</span>
        </div>
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          {subject.name} Lobbyists in Texas
        </h1>
        <p class="text-xl text-white/90 mb-6">{subject.description}</p>

        {/* Subject Stats */}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <div class="text-2xl font-bold">{lobbyists?.length || 0}</div>
            <div class="text-sm text-white/80">Experts</div>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <div class="text-2xl font-bold">{featuredCount + premiumCount}</div>
            <div class="text-sm text-white/80">Premium</div>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <div class="text-2xl font-bold">{Object.keys(cityCounts).length}</div>
            <div class="text-sm text-white/80">Cities Served</div>
          </div>
          <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
            <div class="text-2xl font-bold">{avgYearsExperience}+</div>
            <div class="text-sm text-white/80">Avg. Years Exp</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-12">
    <div class="container">
      <div class="grid lg:grid-cols-4 gap-8">
        <!-- Sidebar Filters -->
        <div class="lg:col-span-1">
          <div class="sticky top-6 space-y-6">
            <!-- City Filter -->
            <div class="rounded-lg border border-border bg-white p-6">
              <h3 class="font-semibold mb-4">Filter by City</h3>
              <div class="space-y-2">
                <a
                  href={`/subjects/${slug}`}
                  class="block text-sm py-2 px-3 rounded hover:bg-muted transition-colors"
                >
                  All Cities ({lobbyists?.length || 0})
                </a>
                {cities?.map((city) => {
                  const count = cityCounts[city.slug] || 0;
                  if (count === 0) return null;
                  return (
                    <a
                      href={`/subjects/${slug}?city=${city.slug}`}
                      class="block text-sm py-2 px-3 rounded hover:bg-muted transition-colors"
                    >
                      {city.name} ({count})
                    </a>
                  );
                })}
              </div>
            </div>

            <!-- Top Cities */}
            {
              topCities.length > 0 && (
                <div class="rounded-lg border border-border bg-muted/30 p-6">
                  <h3 class="font-semibold mb-4">Most Active Cities</h3>
                  <div class="space-y-2">
                    {topCities.map(([city, count]) => (
                      <div class="flex items-center justify-between text-sm">
                        <span class="capitalize">{city.replace('-', ' ')}</span>
                        <span class="text-muted-foreground">{count}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )
            }

            <!-- CTA for Lobbyists -->}
            <div class="rounded-lg border border-texas-gold-500 bg-texas-gold-500/5 p-6">
              <h3 class="font-semibold mb-2">Are you a lobbyist?</h3>
              <p class="text-sm text-muted-foreground mb-4">
                Add {subject.name} to your expertise areas and get discovered by businesses in
                this sector.
              </p>
              <a
                href="/claim-profile"
                class="inline-flex items-center justify-center rounded-md bg-texas-gold-500 px-4 py-2 text-sm font-medium text-white hover:bg-texas-gold-500/90 transition-colors w-full"
              >
                Claim Your Profile
              </a>
            </div>
          </div>
        </div>

        <!-- Lobbyists List -->
        <div class="lg:col-span-3">
          {
            lobbyists && lobbyists.length > 0 ? (
              <div class="space-y-6">
                {/* Results Header */}
                <div class="flex items-center justify-between">
                  <h2 class="text-2xl font-bold">
                    {lobbyists.length} {subject.name} Expert{lobbyists.length !== 1 ? 's' : ''}
                  </h2>
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-muted-foreground">Sort by:</span>
                    <select class="text-sm border border-border rounded-md px-3 py-1.5 bg-white">
                      <option>Most Relevant</option>
                      <option>Most Viewed</option>
                      <option>Newest First</option>
                    </select>
                  </div>
                </div>

                {/* Lobbyists Grid */}
                <div class="grid gap-6">
                  {lobbyists.map((lobbyist) => (
                    <LobbyistCard client:load lobbyist={lobbyist} />
                  ))}
                </div>
              </div>
            ) : (
              /* Empty State */
              <div class="text-center py-16 rounded-lg border border-dashed border-border">
                <svg
                  class="mx-auto h-16 w-16 text-muted-foreground/50"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="1.5"
                    d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                  />
                </svg>
                <h3 class="mt-4 text-xl font-semibold">No lobbyists found</h3>
                <p class="mt-2 text-muted-foreground">
                  We don't have any registered lobbyists specializing in {subject.name} yet.
                </p>
                <div class="mt-6 flex gap-3 justify-center">
                  <a
                    href="/subjects"
                    class="inline-flex items-center justify-center rounded-md border border-border px-4 py-2 text-sm font-medium hover:bg-accent transition-colors"
                  >
                    Browse All Subjects
                  </a>
                  <a
                    href="/claim-profile"
                    class="inline-flex items-center justify-center rounded-md bg-texas-blue px-4 py-2 text-sm font-medium text-white hover:bg-texas-blue-500/90 transition-colors"
                  >
                    Add Your Expertise
                  </a>
                </div>
              </div>
            )
          }

          {/* Why Hire a Subject Expert */}
          <div class="mt-12 rounded-lg border border-border bg-muted/30 p-8">
            <h2 class="text-2xl font-bold mb-4">
              Why Hire a {subject.name} Lobbyist?
            </h2>
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <h3 class="font-semibold mb-2 flex items-center gap-2">
                  <svg
                    class="h-5 w-5 text-texas-blue-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"></path>
                  </svg>
                  Industry Expertise
                </h3>
                <p class="text-sm text-muted-foreground">
                  Deep understanding of {subject.name.toLowerCase()} policy, regulations, and
                  legislative priorities.
                </p>
              </div>
              <div>
                <h3 class="font-semibold mb-2 flex items-center gap-2">
                  <svg
                    class="h-5 w-5 text-texas-blue-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"></path>
                  </svg>
                  Proven Track Record
                </h3>
                <p class="text-sm text-muted-foreground">
                  Experience working with similar businesses and achieving results in your sector.
                </p>
              </div>
              <div>
                <h3 class="font-semibold mb-2 flex items-center gap-2">
                  <svg
                    class="h-5 w-5 text-texas-blue-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"></path>
                  </svg>
                  Committee Relationships
                </h3>
                <p class="text-sm text-muted-foreground">
                  Connections with relevant legislative committees and key decision-makers.
                </p>
              </div>
              <div>
                <h3 class="font-semibold mb-2 flex items-center gap-2">
                  <svg
                    class="h-5 w-5 text-texas-blue-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                      clip-rule="evenodd"></path>
                  </svg>
                  Strategic Guidance
                </h3>
                <p class="text-sm text-muted-foreground">
                  Insider knowledge of legislative calendars, timing, and effective advocacy
                  strategies.
                </p>
              </div>
            </div>
          </div>

          {/* CTA Section */}
          <div class="mt-12 rounded-lg bg-gradient-to-br from-texas-blue to-texas-blue/80 text-white p-8">
            <div class="max-w-2xl">
              <h2 class="text-3xl font-bold mb-3">
                Need {subject.name} Expertise?
              </h2>
              <p class="text-white/90 mb-6">
                Connect with experienced {subject.name.toLowerCase()} lobbyists who understand your
                industry and have the relationships to get results.
              </p>
              <div class="flex flex-col sm:flex-row gap-3">
                <a
                  href="/signup"
                  class="inline-flex items-center justify-center rounded-md bg-white px-6 py-3 text-base font-medium text-texas-blue-500 hover:bg-white/90 transition-colors"
                >
                  Get Started
                </a>
                <a
                  href="/lobbyists"
                  class="inline-flex items-center justify-center rounded-md border-2 border-white px-6 py-3 text-base font-medium text-white hover:bg-white/10 transition-colors"
                >
                  Browse All Lobbyists
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>
